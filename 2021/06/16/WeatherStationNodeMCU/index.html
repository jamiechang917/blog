<!DOCTYPE html><html lang="zh-TW" data-theme="dark"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><title>天文用攜帶型天氣站 | Jamie's Blog</title><meta name="keywords" content="astrophotography,maker"><meta name="author" content="Jamie Chang"><meta name="copyright" content="Jamie Chang"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#0d0d0d"><meta name="description" content="利用NodeMCU-32s及感測器製作小型天氣站">
<meta property="og:type" content="article">
<meta property="og:title" content="天文用攜帶型天氣站">
<meta property="og:url" content="https://jamiechang917.github.io/blog/2021/06/16/WeatherStationNodeMCU/index.html">
<meta property="og:site_name" content="Jamie&#39;s Blog">
<meta property="og:description" content="利用NodeMCU-32s及感測器製作小型天氣站">
<meta property="og:locale" content="zh_TW">
<meta property="og:image" content="https://i.imgur.com/XuOgEAV.jpg">
<meta property="article:published_time" content="2021-06-16T04:00:00.000Z">
<meta property="article:modified_time" content="2021-06-26T04:00:00.000Z">
<meta property="article:author" content="Jamie Chang">
<meta property="article:tag" content="astrophotography">
<meta property="article:tag" content="maker">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://i.imgur.com/XuOgEAV.jpg"><link rel="shortcut icon" href="/blog/img/favicon_new.png"><link rel="canonical" href="https://jamiechang917.github.io/blog/2021/06/16/WeatherStationNodeMCU/"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/blog/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/node-snackbar/dist/snackbar.min.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = { 
  root: '/blog/',
  algolia: undefined,
  localSearch: {"path":"search.xml","languages":{"hits_empty":"找不到您查詢的內容：${query}"}},
  translate: undefined,
  noticeOutdate: undefined,
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true},
  copy: {
    success: '複製成功',
    error: '複製錯誤',
    noSupport: '瀏覽器不支援'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '天',
  date_suffix: {
    just: '剛剛',
    min: '分鐘前',
    hour: '小時前',
    day: '天前',
    month: '個月前'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: {"chs_to_cht":"你已切換為繁體","cht_to_chs":"你已切換為簡體","day_to_night":"你已切換為深色模式","night_to_day":"你已切換為淺色模式","bgLight":"#49b1f5","bgDark":"#121212","position":"bottom-left"},
  source: {
    jQuery: 'https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js',
    justifiedGallery: {
      js: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/js/jquery.justifiedGallery.min.js',
      css: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/css/justifiedGallery.min.css'
    },
    fancybox: {
      js: 'https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js',
      css: 'https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isanchor: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = { 
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2021-06-26 12:00:00'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          const isDarkMode = window.matchMedia('(prefers-color-scheme: dark)').matches
          const isLightMode = window.matchMedia('(prefers-color-scheme: light)').matches
          const isNotSpecified = window.matchMedia('(prefers-color-scheme: no-preference)').matches
          const hasNoSupport = !isDarkMode && !isLightMode && !isNotSpecified

          if (t === undefined) {
            if (isLightMode) activateLightMode()
            else if (isDarkMode) activateDarkMode()
            else if (isNotSpecified || hasNoSupport) {
              const now = new Date()
              const hour = now.getHours()
              const isNight = hour <= 6 || hour >= 18
              isNight ? activateDarkMode() : activateLightMode()
            }
            window.matchMedia('(prefers-color-scheme: dark)').addListener(function (e) {
              if (saveToLocal.get('theme') === undefined) {
                e.matches ? activateDarkMode() : activateLightMode()
              }
            })
          } else if (t === 'light') activateLightMode()
          else activateDarkMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
    const fontSizeVal = saveToLocal.get('global-font-size')
    if (fontSizeVal !== undefined) {
      document.documentElement.style.setProperty('--global-font-size', fontSizeVal + 'px')
    }
    })(window)</script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css" media="defer" onload= "this.media='all'"><!-- hexo injector head_end start -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css">

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/hexo-math@4.0.0/dist/style.css">
<!-- hexo injector head_end end --><meta name="generator" content="Hexo 5.4.0"></head><body><div id="loading-box"><div class="loading-left-bg"></div><div class="loading-right-bg"></div><div class="spinner-box"><div class="configure-border-1"><div class="configure-core"></div></div><div class="configure-border-2"><div class="configure-core"></div></div><div class="loading-word">載入中...</div></div></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="author-avatar"><img class="avatar-img" src="/blog/img/avatar_img.jpg" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="site-data"><div class="data-item is-center"><div class="data-item-link"><a href="/blog/archives/"><div class="headline">文章</div><div class="length-num">7</div></a></div></div><div class="data-item is-center"><div class="data-item-link"><a href="/blog/tags/"><div class="headline">標籤</div><div class="length-num">5</div></a></div></div><div class="data-item is-center"><div class="data-item-link"><a href="/blog/categories/"><div class="headline">分類</div><div class="length-num">3</div></a></div></div></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/blog/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/blog/archives/"><i class="fa-fw fas fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/blog/categories/"><i class="fa-fw fas fa-folder-open"></i><span> Categories</span></a></div><div class="menus_item"><a class="site-page" href="/blog/tags/"><i class="fa-fw fas fa-tags"></i><span> Tags</span></a></div><div class="menus_item"><a class="site-page" href="/blog/info/"><i class="fa-fw fas fa-info-circle"></i><span> Info</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url('https://i.imgur.com/XuOgEAV.jpg')"><nav id="nav"><span id="blog_name"><a id="site-name" href="/blog/">Jamie's Blog</a></span><div id="menus"><div id="search-button"><a class="site-page social-icon search"><i class="fas fa-search fa-fw"></i><span> 搜尋</span></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/blog/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/blog/archives/"><i class="fa-fw fas fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/blog/categories/"><i class="fa-fw fas fa-folder-open"></i><span> Categories</span></a></div><div class="menus_item"><a class="site-page" href="/blog/tags/"><i class="fa-fw fas fa-tags"></i><span> Tags</span></a></div><div class="menus_item"><a class="site-page" href="/blog/info/"><i class="fa-fw fas fa-info-circle"></i><span> Info</span></a></div></div><div id="toggle-menu"><a class="site-page"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">天文用攜帶型天氣站</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">發表於</span><time class="post-meta-date-created" datetime="2021-06-16T04:00:00.000Z" title="發表於 2021-06-16 12:00:00">2021-06-16</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新於</span><time class="post-meta-date-updated" datetime="2021-06-26T04:00:00.000Z" title="更新於 2021-06-26 12:00:00">2021-06-26</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/blog/categories/maker/">maker</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">字數總計:</span><span class="word-count">10.2k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">閱讀時長:</span><span>49分鐘</span></span><span class="post-meta-separator">|</span><span class="post-meta-pv-cv"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">閱讀量:</span><span id="busuanzi_value_page_pv"></span></span><span class="post-meta-separator">|</span><span class="post-meta-commentcount"><i class="far fa-comments fa-fw post-meta-icon"></i><span class="post-meta-label">評論數:</span><span class="disqus-comment-count"><a href="https://jamiechang917.github.io/blog/2021/06/16/WeatherStationNodeMCU/#disqus_thread"></a></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><h1 id="天文用攜帶型天氣站"><a href="#天文用攜帶型天氣站" class="headerlink" title="天文用攜帶型天氣站"></a>天文用攜帶型天氣站</h1><div class="note info modern"><p>製作日期：2021/06/16 (三) ~ 2021/06/22 (二)</p>
</div>
<h2 id="基本介紹"><a href="#基本介紹" class="headerlink" title="基本介紹"></a>基本介紹</h2><p>對於天文觀測或是天文攝影，一個光害少的好地點是必須的。那麼我們要怎麼判斷一個地方的光害汙染程度呢，這時候科學家定義了新的標準，來衡量天空背景亮度的強度。而目前業餘常見的測量儀器是加拿大公司  Unihedron 出的Sky Quality Meter。</p>
<p><img src="https://i.imgur.com/VjFPIFK.jpg" alt=""></p>
<p>這種手持式的儀器在業餘天文界算是常見，操作方式很簡單，僅需要對準天空，裡面的感測器就會測量光強度，並換算成SQM數值，夜空的數值一般介於 16~22 ，數字越大代表光害越小，可以用來對不同地方的光汙染進行比較。</p>
<p><img src="https://i.imgur.com/PgS3o6j.jpg" alt=""></p>
<p>此外，天文攝影很注重環境的溫溼度，相機在不同溫度下自然產生的熱雜訊的強度會不同，需要記錄環境溫度，後期才能根據該溫度拍攝對應的校正檔，來修正我們所得到的資料。而濕度可以很大程度的影響我們拍攝，當濕度過高時望遠鏡很容易結露，對鏡面和相機傷害較大，因此如果能觀測環境濕度也能幫助我們在濕度過高的情況下及時保護儀器。</p>
<p><img src="https://i.imgur.com/rl8W0K9.jpg" alt=""></p>
<p>但是但是，<strong>市面上同時結合SQM和溫溼度的商品非常昂貴(NT 5000+)</strong>，而且幾乎找不到，而這種看似不起眼的攜帶型天氣站卻對天文觀測非常重要，因此我打算做一個基於ESP32的天文用攜帶型天氣站，並利用ESP32的網路功能，結合第三方網站達到隨時用手機或電腦就能監控的功能，還能一併將數據紀錄起來。</p>
<p>以下材料是我這次有用到的，材料約一千出頭。</p>
<p><img src="https://i.imgur.com/KgHyoQ0.jpg" alt=""></p>
<div class="table-container">
<table>
<thead>
<tr>
<th style="text-align:center">品項</th>
<th style="text-align:center">價格</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">NodeMCU-32S 開發板</td>
<td style="text-align:center">360</td>
</tr>
<tr>
<td style="text-align:center">BME280 溫溼度氣壓感測器</td>
<td style="text-align:center">210</td>
</tr>
<tr>
<td style="text-align:center">TSL2591 環境光感測器</td>
<td style="text-align:center">290</td>
</tr>
<tr>
<td style="text-align:center">1.8吋 TFT螢幕</td>
<td style="text-align:center">210</td>
</tr>
</tbody>
</table>
</div>
<h3 id="開發板及感測器介紹"><a href="#開發板及感測器介紹" class="headerlink" title="開發板及感測器介紹"></a>開發板及感測器介紹</h3><h3 id="NodeMCU-32S"><a href="#NodeMCU-32S" class="headerlink" title="NodeMCU-32S"></a>NodeMCU-32S</h3><p>這次我購買的是AI-thinker的NodeMCU-32S v1.3，聽說相比其他的ESP32開發板，這款在Wifi連線方面十分穩定，不會出現斷線等問題。</p>
<p><img src="https://i.imgur.com/YqwfeQ1.jpg" alt=""></p>
<p><img src="https://i.imgur.com/JGxwGq4.jpg" alt=""></p>
<p><img src="https://i.imgur.com/G0NOTTR.jpg" alt=""></p>
<p><img src="https://i.imgur.com/Fgw00fL.png" alt=""></p>
<p><img src="https://i.imgur.com/zmneVfD.png" alt=""></p>
<p>NodeMCU-32S是基於ESP32並且內建Wifi及藍芽晶片的開發板，可以兼容Arduino的感測器及語法，各項功能也比Arduino Uno強，針腳高達38個，並且NodeMCU-32S的Vin支持5V輸出，可以用來推動3.3V推不動的裝置。</p>
<div class="table-container">
<table>
<thead>
<tr>
<th style="text-align:center"></th>
<th style="text-align:center">Arduino Uno</th>
<th style="text-align:center">ESP8266</th>
<th style="text-align:center">ESP32</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">MCU</td>
<td style="text-align:center">ATMega328P</td>
<td style="text-align:center">Tensilica Xtensa Lx106</td>
<td style="text-align:center">Tensilica Xtensa LX6</td>
</tr>
<tr>
<td style="text-align:center">核心</td>
<td style="text-align:center">單核心 20MHz</td>
<td style="text-align:center">單核心 80/160MHz</td>
<td style="text-align:center">雙核心 160/240MHz</td>
</tr>
<tr>
<td style="text-align:center">SRAM</td>
<td style="text-align:center">16KB</td>
<td style="text-align:center">160KB</td>
<td style="text-align:center">512KB</td>
</tr>
<tr>
<td style="text-align:center">Flash空間</td>
<td style="text-align:center">32KB</td>
<td style="text-align:center">1-4MB</td>
<td style="text-align:center">4-32MB</td>
</tr>
<tr>
<td style="text-align:center">GPIO</td>
<td style="text-align:center">13</td>
<td style="text-align:center">8</td>
<td style="text-align:center">18</td>
</tr>
<tr>
<td style="text-align:center">ADC</td>
<td style="text-align:center">8</td>
<td style="text-align:center">1</td>
<td style="text-align:center">18</td>
</tr>
<tr>
<td style="text-align:center">PWM</td>
<td style="text-align:center">6</td>
<td style="text-align:center">8</td>
<td style="text-align:center">16</td>
</tr>
<tr>
<td style="text-align:center">類比解析度</td>
<td style="text-align:center">1024</td>
<td style="text-align:center">1024</td>
<td style="text-align:center">4096</td>
</tr>
<tr>
<td style="text-align:center">I2C</td>
<td style="text-align:center">1組</td>
<td style="text-align:center">1組</td>
<td style="text-align:center">2組</td>
</tr>
<tr>
<td style="text-align:center">SPI</td>
<td style="text-align:center">1組</td>
<td style="text-align:center">1組</td>
<td style="text-align:center">3組</td>
</tr>
<tr>
<td style="text-align:center">Wifi</td>
<td style="text-align:center">無</td>
<td style="text-align:center">802.11 b/g/n</td>
<td style="text-align:center">802.11 b/g/n</td>
</tr>
<tr>
<td style="text-align:center">Bluetooth</td>
<td style="text-align:center">無</td>
<td style="text-align:center">無</td>
<td style="text-align:center">BLE 4.2</td>
</tr>
<tr>
<td style="text-align:center">內建溫度感測</td>
<td style="text-align:center">無</td>
<td style="text-align:center">無</td>
<td style="text-align:center">有</td>
</tr>
<tr>
<td style="text-align:center">內建霍爾感測器</td>
<td style="text-align:center">無</td>
<td style="text-align:center">無</td>
<td style="text-align:center">有</td>
</tr>
<tr>
<td style="text-align:center">內建觸控電容</td>
<td style="text-align:center">無</td>
<td style="text-align:center">無</td>
<td style="text-align:center">10組</td>
</tr>
<tr>
<td style="text-align:center">售價</td>
<td style="text-align:center">100-200</td>
<td style="text-align:center">100-200</td>
<td style="text-align:center">200-300</td>
</tr>
</tbody>
</table>
</div>
<p>NodeMCU-32S 通訊腳位</p>
<div class="table-container">
<table>
<thead>
<tr>
<th style="text-align:center">SPI</th>
<th style="text-align:center">MOSI</th>
<th style="text-align:center">MISO</th>
<th style="text-align:center">CLK</th>
<th style="text-align:center">CS</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">HSPI</td>
<td style="text-align:center">GPIO13</td>
<td style="text-align:center">GPIO12</td>
<td style="text-align:center">GPIO14</td>
<td style="text-align:center">GPIO15</td>
</tr>
<tr>
<td style="text-align:center">VSPI</td>
<td style="text-align:center">GPIO23</td>
<td style="text-align:center">GPIO19</td>
<td style="text-align:center">GPIO18</td>
<td style="text-align:center">GPIO5</td>
</tr>
</tbody>
</table>
</div>
<div class="table-container">
<table>
<thead>
<tr>
<th style="text-align:center">I2C</th>
<th style="text-align:center">SDA</th>
<th style="text-align:center">SCL</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">I2C</td>
<td style="text-align:center">GPIO21</td>
<td style="text-align:center">GPIO22</td>
</tr>
</tbody>
</table>
</div>
<p>只能作為輸入的GPIO為GPIO34, GPIO35, GPIO36, GPIO39, 其他針腳都可以雙向輸入輸出。</p>
<h3 id="BME280-溫溼度氣壓感測器"><a href="#BME280-溫溼度氣壓感測器" class="headerlink" title="BME280 溫溼度氣壓感測器"></a>BME280 溫溼度氣壓感測器</h3><p>BME280相比常見的DHT11, DHT22，有更高的精度，而且它也內建了氣壓感測器，可以用來量測高度及環境氣壓，對於天氣站來說相當適合。市面上的BME280有分3.3V和5V兩種，我購買的是3.3V版本，這點要特別注意，以免將感測器燒掉。另外買來需要將針腳焊接上去。</p>
<p><img src="https://i.imgur.com/HKs2xz0.jpg" alt=""></p>
<p>買來發現它的尺寸真的超級小，看來很省空間</p>
<p><img src="https://i.imgur.com/XqfVIjP.jpg" alt=""></p>
<p><img src="https://i.imgur.com/tC5pFwr.jpg" alt=""></p>
<div class="table-container">
<table>
<thead>
<tr>
<th style="text-align:center"></th>
<th style="text-align:center">DHT11</th>
<th style="text-align:center">DHT12</th>
<th style="text-align:center">BME280</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">感測功能</td>
<td style="text-align:center">溫度，濕度</td>
<td style="text-align:center">溫度，濕度</td>
<td style="text-align:center">溫度，濕度，氣壓</td>
</tr>
<tr>
<td style="text-align:center">溫度範圍</td>
<td style="text-align:center">0~50ºC</td>
<td style="text-align:center">-40~80ºC</td>
<td style="text-align:center">-40~85ºC</td>
</tr>
<tr>
<td style="text-align:center">溫度精度/解析度</td>
<td style="text-align:center">+-2ºC/1°C</td>
<td style="text-align:center">+-0.5ºC/0.1ºC</td>
<td style="text-align:center">+-0.5ºC/0.01°C</td>
</tr>
<tr>
<td style="text-align:center">濕度範圍</td>
<td style="text-align:center">20~90%</td>
<td style="text-align:center">0~100%</td>
<td style="text-align:center">0~100%</td>
</tr>
<tr>
<td style="text-align:center">濕度精度/解析度</td>
<td style="text-align:center">+-5%/1%</td>
<td style="text-align:center">+-5%/0.1%</td>
<td style="text-align:center">+-3%/0.008%</td>
</tr>
<tr>
<td style="text-align:center">氣壓範圍</td>
<td style="text-align:center">無</td>
<td style="text-align:center">無</td>
<td style="text-align:center">300-1100hPa</td>
</tr>
<tr>
<td style="text-align:center">氣壓精度/解析度</td>
<td style="text-align:center">無</td>
<td style="text-align:center">無</td>
<td style="text-align:center">+-1hPa/0.18hPa</td>
</tr>
</tbody>
</table>
</div>
<p>搜尋bme280來安裝函式庫，有很多種版本，我安裝的是Adafruit的。</p>
<p><img src="https://i.imgur.com/SBgPPAM.jpg" alt=""></p>
<div class="table-container">
<table>
<thead>
<tr>
<th style="text-align:center">腳位</th>
<th style="text-align:center">NodeMCU-32S</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">Vcc</td>
<td style="text-align:center">3.3V</td>
</tr>
<tr>
<td style="text-align:center">GND</td>
<td style="text-align:center">GND</td>
</tr>
<tr>
<td style="text-align:center">SCL</td>
<td style="text-align:center">GPIO18</td>
</tr>
<tr>
<td style="text-align:center">SDA(MOSI)</td>
<td style="text-align:center">GPIO23</td>
</tr>
<tr>
<td style="text-align:center">CSE</td>
<td style="text-align:center">GPIO5</td>
</tr>
<tr>
<td style="text-align:center">SDO(MISO)</td>
<td style="text-align:center">GPIO19</td>
</tr>
</tbody>
</table>
</div>
<p>這款可以用I2C或是SPI通訊，我選擇用I2C通訊，因此只需要接SDA和SCL，我將SCL接到GPIO22，SDA接到GPIO21。接下來使用下面的測試程式碼，我們使用I2C所以不用更改，若使用SPI則須將注釋掉的地方做修改。高度計功能則需要依賴設定平地氣壓為前提去計算，因此這裡設定一大氣壓(1013.25百帕)。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;Wire.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;Adafruit_Sensor.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;Adafruit_BME280.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*#include &lt;SPI.h&gt;</span></span><br><span class="line"><span class="comment">#define BME_SCK 18</span></span><br><span class="line"><span class="comment">#define BME_MISO 19</span></span><br><span class="line"><span class="comment">#define BME_MOSI 23</span></span><br><span class="line"><span class="comment">#define BME_CS 5*/</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> SEALEVELPRESSURE_HPA (1013.25)</span></span><br><span class="line"></span><br><span class="line">Adafruit_BME280 bme; <span class="comment">// I2C</span></span><br><span class="line"><span class="comment">//Adafruit_BME280 bme(BME_CS); // hardware SPI</span></span><br><span class="line"><span class="comment">//Adafruit_BME280 bme(BME_CS, BME_MOSI, BME_MISO, BME_SCK); // software SPI</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">long</span> delayTime;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">setup</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  Serial.begin(<span class="number">9600</span>);</span><br><span class="line">  Serial.println(F(<span class="string">&quot;BME280 test&quot;</span>));</span><br><span class="line"></span><br><span class="line">  <span class="keyword">bool</span> status;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// default settings</span></span><br><span class="line">  <span class="comment">// (you can also pass in a Wire library object like &amp;Wire2)</span></span><br><span class="line">  status = bme.begin(<span class="number">0x76</span>);  </span><br><span class="line">  <span class="keyword">if</span> (!status) &#123;</span><br><span class="line">    Serial.println(<span class="string">&quot;Could not find a valid BME280 sensor, check wiring!&quot;</span>);</span><br><span class="line">    <span class="keyword">while</span> (<span class="number">1</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  Serial.println(<span class="string">&quot;-- Default Test --&quot;</span>);</span><br><span class="line">  delayTime = <span class="number">1000</span>;</span><br><span class="line"></span><br><span class="line">  Serial.println();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">loop</span><span class="params">()</span> </span>&#123; </span><br><span class="line">  printValues();</span><br><span class="line">  delay(delayTime);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">printValues</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  Serial.print(<span class="string">&quot;Temperature = &quot;</span>);</span><br><span class="line">  Serial.print(bme.readTemperature());</span><br><span class="line">  Serial.println(<span class="string">&quot; *C&quot;</span>);</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// Convert temperature to Fahrenheit</span></span><br><span class="line">  <span class="comment">/*Serial.print(&quot;Temperature = &quot;);</span></span><br><span class="line"><span class="comment">  Serial.print(1.8 * bme.readTemperature() + 32);</span></span><br><span class="line"><span class="comment">  Serial.println(&quot; *F&quot;);*/</span></span><br><span class="line">  </span><br><span class="line">  Serial.print(<span class="string">&quot;Pressure = &quot;</span>);</span><br><span class="line">  Serial.print(bme.readPressure() / <span class="number">100.0F</span>);</span><br><span class="line">  Serial.println(<span class="string">&quot; hPa&quot;</span>);</span><br><span class="line"></span><br><span class="line">  Serial.print(<span class="string">&quot;Approx. Altitude = &quot;</span>);</span><br><span class="line">  Serial.print(bme.readAltitude(SEALEVELPRESSURE_HPA));</span><br><span class="line">  Serial.println(<span class="string">&quot; m&quot;</span>);</span><br><span class="line"></span><br><span class="line">  Serial.print(<span class="string">&quot;Humidity = &quot;</span>);</span><br><span class="line">  Serial.print(bme.readHumidity());</span><br><span class="line">  Serial.println(<span class="string">&quot; %&quot;</span>);</span><br><span class="line"></span><br><span class="line">  Serial.println();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>將baud設定成9600，你應該可以看到感測器輸出的數據了</p>
<p><img src="https://i.imgur.com/ATSJCdK.jpg" alt=""></p>
<p>更多詳細資料：<a target="_blank" rel="noopener" href="https://randomnerdtutorials.com/esp32-web-server-with-bme280-mini-weather-station/">https://randomnerdtutorials.com/esp32-web-server-with-bme280-mini-weather-station/</a></p>
<h3 id="TSL2591-環境光感測器"><a href="#TSL2591-環境光感測器" class="headerlink" title="TSL2591 環境光感測器"></a>TSL2591 環境光感測器</h3><p>TSL2591是一個超高靈敏度的光感測器，從 188 μlux 到 88000 lux 都能量測，動態範圍相當廣。支持3.3V~5V輸入，使用I2C通訊。另外它能夠量測黑暗環境下的光強度，可以應用在測量SQM(Sky Quality Meter)上，所以被我挑選當光感測器。挑選時要注意大部分的光感測器無法測量到 0.1 lux 以下的光照度，對於測量暗空品質而言，至少要到能量到 0.0003 lux 的靈敏度。</p>
<div class="table-container">
<table>
<thead>
<tr>
<th style="text-align:center">環境</th>
<th style="text-align:center">照度(lux)</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">烈日</td>
<td style="text-align:center">100000</td>
</tr>
<tr>
<td style="text-align:center">陰天</td>
<td style="text-align:center">500~6000</td>
</tr>
<tr>
<td style="text-align:center">室內</td>
<td style="text-align:center">300</td>
</tr>
<tr>
<td style="text-align:center">路燈</td>
<td style="text-align:center">5</td>
</tr>
<tr>
<td style="text-align:center">滿月</td>
<td style="text-align:center">0.2</td>
</tr>
<tr>
<td style="text-align:center">星空</td>
<td style="text-align:center">0.0003</td>
</tr>
</tbody>
</table>
</div>
<p><img src="https://i.imgur.com/ASdLXMn.jpg" alt=""></p>
<p>先安裝TSL2591的函式庫，我用的是Adafruit的。</p>
<p><img src="https://i.imgur.com/RdwQyLW.jpg" alt=""></p>
<div class="table-container">
<table>
<thead>
<tr>
<th style="text-align:center">針腳</th>
<th style="text-align:center">NodeMCU-32S</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">Vin</td>
<td style="text-align:center">3.3V/5V</td>
</tr>
<tr>
<td style="text-align:center">GND</td>
<td style="text-align:center">GND</td>
</tr>
<tr>
<td style="text-align:center">3vo</td>
<td style="text-align:center">輸出3.3V(100mA max)</td>
</tr>
<tr>
<td style="text-align:center">Int</td>
<td style="text-align:center">INTerrupt pin(暫時用不到)</td>
</tr>
<tr>
<td style="text-align:center">SDA</td>
<td style="text-align:center">GPIO21</td>
</tr>
<tr>
<td style="text-align:center">SCL</td>
<td style="text-align:center">GPIO22</td>
</tr>
</tbody>
</table>
</div>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* TSL2591 Digital Light Sensor */</span></span><br><span class="line"><span class="comment">/* Dynamic Range: 600M:1 */</span></span><br><span class="line"><span class="comment">/* Maximum Lux: 88K */</span></span><br><span class="line"> </span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;Wire.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;Adafruit_Sensor.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;Adafruit_TSL2591.h&quot;</span></span></span><br><span class="line"> </span><br><span class="line"><span class="comment">// Example for demonstrating the TSL2591 library - public domain!</span></span><br><span class="line"> </span><br><span class="line"><span class="comment">// connect SCL to I2C Clock</span></span><br><span class="line"><span class="comment">// connect SDA to I2C Data</span></span><br><span class="line"><span class="comment">// connect Vin to 3.3-5V DC</span></span><br><span class="line"><span class="comment">// connect GROUND to common ground</span></span><br><span class="line"> </span><br><span class="line">Adafruit_TSL2591 tsl = Adafruit_TSL2591(<span class="number">2591</span>); <span class="comment">// pass in a number for the sensor identifier (for your use later)</span></span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line"><span class="comment">/**************************************************************************/</span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">    Configures the gain and integration time for the TSL2591</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="comment">/**************************************************************************/</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">configureSensor</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="comment">// You can change the gain on the fly, to adapt to brighter/dimmer light situations</span></span><br><span class="line">  <span class="comment">//tsl.setGain(TSL2591_GAIN_LOW);    // 1x gain (bright light)</span></span><br><span class="line">  tsl.setGain(TSL2591_GAIN_MED);      <span class="comment">// 25x gain</span></span><br><span class="line">  <span class="comment">//tsl.setGain(TSL2591_GAIN_HIGH);   // 428x gain</span></span><br><span class="line"> </span><br><span class="line">  <span class="comment">// Changing the integration time gives you a longer time over which to sense light</span></span><br><span class="line">  <span class="comment">// longer timelines are slower, but are good in very low light situtations!</span></span><br><span class="line">  <span class="comment">//tsl.setTiming(TSL2591_INTEGRATIONTIME_100MS);  // shortest integration time (bright light)</span></span><br><span class="line">  <span class="comment">// tsl.setTiming(TSL2591_INTEGRATIONTIME_200MS);</span></span><br><span class="line">  tsl.setTiming(TSL2591_INTEGRATIONTIME_300MS);</span><br><span class="line">  <span class="comment">// tsl.setTiming(TSL2591_INTEGRATIONTIME_400MS);</span></span><br><span class="line">  <span class="comment">// tsl.setTiming(TSL2591_INTEGRATIONTIME_500MS);</span></span><br><span class="line">  <span class="comment">// tsl.setTiming(TSL2591_INTEGRATIONTIME_600MS);  // longest integration time (dim light)</span></span><br><span class="line"> </span><br><span class="line">  <span class="comment">/* Display the gain and integration time for reference sake */</span>  </span><br><span class="line">  Serial.println(F(<span class="string">&quot;------------------------------------&quot;</span>));</span><br><span class="line">  Serial.print  (F(<span class="string">&quot;Gain:         &quot;</span>));</span><br><span class="line">  tsl2591Gain_t gain = tsl.getGain();</span><br><span class="line">  <span class="keyword">switch</span>(gain)</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">case</span> TSL2591_GAIN_LOW:</span><br><span class="line">      Serial.println(F(<span class="string">&quot;1x (Low)&quot;</span>));</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> TSL2591_GAIN_MED:</span><br><span class="line">      Serial.println(F(<span class="string">&quot;25x (Medium)&quot;</span>));</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> TSL2591_GAIN_HIGH:</span><br><span class="line">      Serial.println(F(<span class="string">&quot;428x (High)&quot;</span>));</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> TSL2591_GAIN_MAX:</span><br><span class="line">      Serial.println(F(<span class="string">&quot;9876x (Max)&quot;</span>));</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  Serial.print  (F(<span class="string">&quot;Timing:       &quot;</span>));</span><br><span class="line">  Serial.print((tsl.getTiming() + <span class="number">1</span>) * <span class="number">100</span>, DEC); </span><br><span class="line">  Serial.println(F(<span class="string">&quot; ms&quot;</span>));</span><br><span class="line">  Serial.println(F(<span class="string">&quot;------------------------------------&quot;</span>));</span><br><span class="line">  Serial.println(F(<span class="string">&quot;&quot;</span>));</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">setup</span><span class="params">(<span class="keyword">void</span>)</span> </span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  Serial.begin(<span class="number">9600</span>);</span><br><span class="line"> </span><br><span class="line">  Serial.println(F(<span class="string">&quot;Starting Adafruit TSL2591 Test!&quot;</span>));</span><br><span class="line"> </span><br><span class="line">  <span class="keyword">if</span> (tsl.begin()) </span><br><span class="line">  &#123;</span><br><span class="line">    Serial.println(F(<span class="string">&quot;Found a TSL2591 sensor&quot;</span>));</span><br><span class="line">  &#125; </span><br><span class="line">  <span class="keyword">else</span> </span><br><span class="line">  &#123;</span><br><span class="line">    Serial.println(F(<span class="string">&quot;No sensor found ... check your wiring?&quot;</span>));</span><br><span class="line">    <span class="keyword">while</span> (<span class="number">1</span>);</span><br><span class="line">  &#125;</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line">  <span class="comment">/* Configure the sensor */</span></span><br><span class="line">  configureSensor();</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="comment">/**************************************************************************/</span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">    Shows how to perform a basic read on visible, full spectrum or</span></span><br><span class="line"><span class="comment">    infrared light (returns raw 16-bit ADC values)</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="comment">/**************************************************************************/</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">simpleRead</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="comment">// Simple data read example. Just read the infrared, fullspecrtrum diode </span></span><br><span class="line">  <span class="comment">// or &#x27;visible&#x27; (difference between the two) channels.</span></span><br><span class="line">  <span class="comment">// This can take 100-600 milliseconds! Uncomment whichever of the following you want to read</span></span><br><span class="line">  <span class="keyword">uint16_t</span> x = tsl.getLuminosity(TSL2591_VISIBLE);</span><br><span class="line">  <span class="comment">//uint16_t x = tsl.getLuminosity(TSL2591_FULLSPECTRUM);</span></span><br><span class="line">  <span class="comment">//uint16_t x = tsl.getLuminosity(TSL2591_INFRARED);</span></span><br><span class="line"> </span><br><span class="line">  Serial.print(F(<span class="string">&quot;[ &quot;</span>)); Serial.print(millis()); Serial.print(F(<span class="string">&quot; ms ] &quot;</span>));</span><br><span class="line">  Serial.print(F(<span class="string">&quot;Luminosity: &quot;</span>));</span><br><span class="line">  Serial.println(x, DEC);</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="comment">/**************************************************************************/</span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">    Show how to read IR and Full Spectrum at once and convert to lux</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="comment">/**************************************************************************/</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">advancedRead</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="comment">// More advanced data read example. Read 32 bits with top 16 bits IR, bottom 16 bits full spectrum</span></span><br><span class="line">  <span class="comment">// That way you can do whatever math and comparisons you want!</span></span><br><span class="line">  <span class="keyword">uint32_t</span> lum = tsl.getFullLuminosity();</span><br><span class="line">  <span class="keyword">uint16_t</span> ir, full;</span><br><span class="line">  ir = lum &gt;&gt; <span class="number">16</span>;</span><br><span class="line">  full = lum &amp; <span class="number">0xFFFF</span>;</span><br><span class="line">  Serial.print(F(<span class="string">&quot;[ &quot;</span>)); Serial.print(millis()); Serial.print(F(<span class="string">&quot; ms ] &quot;</span>));</span><br><span class="line">  Serial.print(F(<span class="string">&quot;IR: &quot;</span>)); Serial.print(ir);  Serial.print(F(<span class="string">&quot;  &quot;</span>));</span><br><span class="line">  Serial.print(F(<span class="string">&quot;Full: &quot;</span>)); Serial.print(full); Serial.print(F(<span class="string">&quot;  &quot;</span>));</span><br><span class="line">  Serial.print(F(<span class="string">&quot;Visible: &quot;</span>)); Serial.print(full - ir); Serial.print(F(<span class="string">&quot;  &quot;</span>));</span><br><span class="line">  Serial.print(F(<span class="string">&quot;Lux: &quot;</span>)); Serial.println(tsl.calculateLux(full, ir), <span class="number">6</span>);</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="comment">/**************************************************************************/</span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">    Performs a read using the Adafruit Unified Sensor API.</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="comment">/**************************************************************************/</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">unifiedSensorAPIRead</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="comment">/* Get a new sensor event */</span> </span><br><span class="line">  <span class="keyword">sensors_event_t</span> event;</span><br><span class="line">  tsl.getEvent(&amp;event);</span><br><span class="line"> </span><br><span class="line">  <span class="comment">/* Display the results (light is measured in lux) */</span></span><br><span class="line">  Serial.print(F(<span class="string">&quot;[ &quot;</span>)); Serial.print(event.timestamp); Serial.print(F(<span class="string">&quot; ms ] &quot;</span>));</span><br><span class="line">  <span class="keyword">if</span> ((event.light == <span class="number">0</span>) |</span><br><span class="line">      (event.light &gt; <span class="number">4294966000.0</span>) | </span><br><span class="line">      (event.light &lt;<span class="number">-4294966000.0</span>))</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="comment">/* If event.light = 0 lux the sensor is probably saturated */</span></span><br><span class="line">    <span class="comment">/* and no reliable data could be generated! */</span></span><br><span class="line">    <span class="comment">/* if event.light is +/- 4294967040 there was a float over/underflow */</span></span><br><span class="line">    Serial.println(F(<span class="string">&quot;Invalid data (adjust gain or timing)&quot;</span>));</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">    Serial.print(event.light); Serial.println(F(<span class="string">&quot; lux&quot;</span>));</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line"><span class="comment">/**************************************************************************/</span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">    Arduino loop function, called once &#x27;setup&#x27; is complete (your own code</span></span><br><span class="line"><span class="comment">    should go here)</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="comment">/**************************************************************************/</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">loop</span><span class="params">(<span class="keyword">void</span>)</span> </span></span><br><span class="line"><span class="function"></span>&#123; </span><br><span class="line">  <span class="comment">//simpleRead(); </span></span><br><span class="line">  advancedRead();</span><br><span class="line">  <span class="comment">// unifiedSensorAPIRead();</span></span><br><span class="line"> </span><br><span class="line">  delay(<span class="number">500</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>上傳後就能看到感測器輸出的訊息了，這一款可以感測紅外光(IR)和紅外線+可見光(IR+Visible)的光強度，相減可以得到可見光的光強度，能應用在不同地方。</p>
<p><img src="https://i.imgur.com/J8aOYnY.jpg" alt=""></p>
<p>從程式碼可以看到，這個感測器可以設定Gain，若要量測高亮度的光源，要將Gain調成Low，如果是要用在黑暗環境下，要將Gain調成High。另外還有Integration Time，時間調越長對偵測黯淡的光會有幫助，但是相對應的感測頻率會降低。</p>
<h3 id="1-8吋TFT螢幕"><a href="#1-8吋TFT螢幕" class="headerlink" title="1.8吋TFT螢幕"></a>1.8吋TFT螢幕</h3><p>這片螢幕的解析度為128x160，透過SPI串口控制，支援5V及3.3V供電，還內建SD卡擴展電路，提供讀寫SD卡的能力，驅動IC是ST7735。經過搜尋這塊螢幕似乎有兩個版本，8pin(SD)和10pin(micro SD)的版本，10pin多出來的是兩個NC針腳，並不需要接線(NC代表Not Connect，不與晶片連結，即空腳)，剩下的8pin跟8pin版本的功能一樣。另外有一側4pin接口是給SD卡用的，板子上印有SD開頭字樣。</p>
<p><img src="https://i.imgur.com/DNkOD8f.jpg" alt=""></p>
<p><img src="https://i.imgur.com/SzTPlT4.jpg" alt=""></p>
<div class="table-container">
<table>
<thead>
<tr>
<th style="text-align:center">pin</th>
<th style="text-align:center">Arduino</th>
<th style="text-align:center">NodeMCU-32S (ai-thinker)</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">Vcc</td>
<td style="text-align:center">3.3V/5V</td>
<td style="text-align:center">3.3V/5V</td>
</tr>
<tr>
<td style="text-align:center">GND</td>
<td style="text-align:center">GND</td>
<td style="text-align:center">GND</td>
</tr>
<tr>
<td style="text-align:center">CLK(SCL,SCK)</td>
<td style="text-align:center">PIN13</td>
<td style="text-align:center">GPIO18</td>
</tr>
<tr>
<td style="text-align:center">SDA(MOSI)</td>
<td style="text-align:center">PIN11</td>
<td style="text-align:center">GPIO23</td>
</tr>
<tr>
<td style="text-align:center">RS(A0,DC)</td>
<td style="text-align:center">PIN8</td>
<td style="text-align:center">任意(這裡選GPIO17)</td>
</tr>
<tr>
<td style="text-align:center">RST</td>
<td style="text-align:center">PIN9</td>
<td style="text-align:center">EN</td>
</tr>
<tr>
<td style="text-align:center">CS(SS)</td>
<td style="text-align:center">PIN10</td>
<td style="text-align:center">GPIO5</td>
</tr>
</tbody>
</table>
</div>
<p>NodeMCU有三組SPI接口，板子命名為SPI,HSPI和VSPI，之間並沒有差別，都是SPI接口，僅是區分不同組而已。</p>
<p>SPI介紹: <a target="_blank" rel="noopener" href="https://ithelp.ithome.com.tw/articles/10245910">https://ithelp.ithome.com.tw/articles/10245910</a></p>
<p>使用前要先安裝Adafruit GFX函式庫，點選Librabies Manager，搜尋ST7735就能找到了。點選安裝就可以了，沒意外它會連GFX函式庫也一起安裝，沒有的話就搜尋一下安裝。</p>
<p><img src="https://i.imgur.com/PWR0wuZ.jpg" alt=""></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;Adafruit_GFX.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;Adafruit_ST7735.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;Fonts/FreeSerif12pt7b.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;Fonts/FreeSansBold9pt7b.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;Fonts/FreeSans9pt7b.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;SPI.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> TFT_CS   5 </span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> TFT_DC   17</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> TFT_RST  0</span></span><br><span class="line"></span><br><span class="line">Adafruit_ST7735 tft = Adafruit_ST7735(TFT_CS, TFT_DC, TFT_RST);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">setup</span><span class="params">(<span class="keyword">void</span>)</span> </span>&#123;</span><br><span class="line">  </span><br><span class="line">  tft.initR(INITR_BLACKTAB);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  tft.setRotation(<span class="number">1</span>);  <span class="comment">//screen rotation</span></span><br><span class="line">  tft.fillScreen(ST77XX_BLACK);  <span class="comment">//filled with black color</span></span><br><span class="line">  tft.setCursor(<span class="number">10</span>, <span class="number">30</span>);</span><br><span class="line">  tft.setTextColor(ST77XX_WHITE);</span><br><span class="line">  tft.setFont(&amp;FreeSerif12pt7b);</span><br><span class="line">  tft.print(<span class="string">&quot;Hello World !&quot;</span>);</span><br><span class="line">  tft.setCursor(<span class="number">0</span>, <span class="number">60</span>);</span><br><span class="line">  tft.setTextColor(ST77XX_RED);</span><br><span class="line">  tft.setFont(&amp;FreeSansBold9pt7b);</span><br><span class="line">  tft.print(<span class="string">&quot;I&#x27;m red !&quot;</span>);</span><br><span class="line">  tft.setCursor(<span class="number">0</span>, <span class="number">80</span>);</span><br><span class="line">  tft.setTextColor(ST77XX_YELLOW);</span><br><span class="line">  tft.setFont(&amp;FreeSans9pt7b);</span><br><span class="line">  tft.print(<span class="string">&quot;I&#x27;m yellow&quot;</span>);</span><br><span class="line">  showIcons();</span><br><span class="line">  </span><br><span class="line">  </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">showIcons</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  tft.fillRoundRect(<span class="number">30</span>, <span class="number">95</span>, <span class="number">30</span>, <span class="number">30</span>, <span class="number">5</span>, ST77XX_MAGENTA); <span class="comment">//x,y,w,h,radius,color</span></span><br><span class="line">  tft.fillCircle(<span class="number">80</span>, <span class="number">110</span>, <span class="number">15</span>, ST77XX_BLUE);  <span class="comment">//x,y,radius</span></span><br><span class="line">  tft.drawRect(<span class="number">105</span>, <span class="number">95</span>, <span class="number">30</span>, <span class="number">30</span>,ST77XX_GREEN);  <span class="comment">//x,y,width,height</span></span><br><span class="line">  delay(<span class="number">500</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">loop</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>顯示效果，背光感覺蠻亮的，下次應該換成OLED試試看。</p>
<p><img src="https://i.imgur.com/f6MAboE.jpg" alt=""></p>
<p>可以透過增加在Vcc前加一顆100歐姆電阻來稍微降低螢幕亮度，可惜這塊螢幕的LED和驅動晶片供電不是分開的，因此不能單獨去控制LED的亮度，若調降太多電壓，螢幕會開不起來。</p>
<p>接著我改寫了一下代碼，透過控制螢幕的Vcc腳位，每隔十秒開關螢幕一次，這樣的功能搭配按鈕就能達成螢幕開關的功能，當需要的時候再打開螢幕，可以省不少電。<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;Adafruit_GFX.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;Adafruit_ST7735.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;Fonts/FreeSerif12pt7b.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;Fonts/FreeSansBold9pt7b.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;Fonts/FreeSans9pt7b.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;SPI.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> TFT_CS   5 </span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> TFT_DC   17</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> TFT_RST  0</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> TFT_Vcc  16</span></span><br><span class="line"></span><br><span class="line">Adafruit_ST7735 tft = Adafruit_ST7735(TFT_CS, TFT_DC, TFT_RST);</span><br><span class="line"><span class="keyword">int</span> screen_switch = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">setup</span><span class="params">(<span class="keyword">void</span>)</span> </span>&#123;</span><br><span class="line">  pinMode(TFT_Vcc, OUTPUT);</span><br><span class="line">  digitalWrite(TFT_Vcc, screen_switch);</span><br><span class="line">  tftInit();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">tftInit</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  tft.initR(INITR_BLACKTAB);</span><br><span class="line"></span><br><span class="line">  tft.setRotation(<span class="number">1</span>);  <span class="comment">//screen rotation</span></span><br><span class="line">  tft.fillScreen(ST77XX_BLACK);  <span class="comment">//filled with black color</span></span><br><span class="line">  tft.setCursor(<span class="number">10</span>, <span class="number">30</span>);</span><br><span class="line">  tft.setTextColor(ST77XX_WHITE);</span><br><span class="line">  tft.setFont(&amp;FreeSerif12pt7b);</span><br><span class="line">  tft.print(<span class="string">&quot;Hello World !&quot;</span>);</span><br><span class="line">  tft.setCursor(<span class="number">0</span>, <span class="number">60</span>);</span><br><span class="line">  tft.setTextColor(ST77XX_RED);</span><br><span class="line">  tft.setFont(&amp;FreeSansBold9pt7b);</span><br><span class="line">  tft.print(<span class="string">&quot;I&#x27;m red !&quot;</span>);</span><br><span class="line">  tft.setCursor(<span class="number">0</span>, <span class="number">80</span>);</span><br><span class="line">  tft.setTextColor(ST77XX_YELLOW);</span><br><span class="line">  tft.setFont(&amp;FreeSans9pt7b);</span><br><span class="line">  tft.print(<span class="string">&quot;I&#x27;m yellow&quot;</span>);</span><br><span class="line"></span><br><span class="line">  delay(<span class="number">500</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">loop</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  screen_switch = <span class="number">1</span> - screen_switch;</span><br><span class="line">  digitalWrite(TFT_Vcc, screen_switch);</span><br><span class="line">  tftInit();</span><br><span class="line">  delay(<span class="number">10000</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>Adafruit GFX 函式庫介紹: <a target="_blank" rel="noopener" href="https://atceiling.blogspot.com/2019/09/arduino65adafruitgfx_7.html">https://atceiling.blogspot.com/2019/09/arduino65adafruitgfx_7.html</a></p>
<h2 id="安裝及配置開發環境"><a href="#安裝及配置開發環境" class="headerlink" title="安裝及配置開發環境"></a>安裝及配置開發環境</h2><p>我這次使用的開發版是NodeMCU-32S，可以用Arduino IDE進行開發。因此我這次使用的是Arduino IDE 2.0，2.0版本目前還在beta測試階段，但是相比舊版的IDE，不僅編譯速度變快，同時也加入許多方便的功能。IDE可以從<a target="_blank" rel="noopener" href="https://www.arduino.cc/en/software">官網</a>下載。</p>
<p><img src="https://i.imgur.com/ECwii2G.jpg" alt=""></p>
<p>點選左上角的File-&gt;Preferences，在最下面一欄添加URL的地方，將下方網址添加給IDE。<br><a target="_blank" rel="noopener" href="https://dl.espressif.com/dl/package_esp32_index.json">https://dl.espressif.com/dl/package_esp32_index.json</a></p>
<p><img src="https://i.imgur.com/mshAqWT.png" alt=""></p>
<p>輸入後點選左側欄位的Board Manager，輸入esp32就可以安裝相關套件了。</p>
<p><img src="https://i.imgur.com/cnajwzk.jpg" alt=""></p>
<p>待電腦安裝完畢，點選上方的no board selected，搜尋nodemcu就能找到NodeMCU-32S的選項，這樣一來就能進行NodeMCU-32S的開發了。</p>
<p><img src="https://i.imgur.com/BDYv3mx.jpg" alt=""></p>
<p>連接開發板後卻發現找不到裝置，這是因為我們還沒安裝驅動，我購買的板子它的USB晶片是CH340C，它的驅動可以在<a target="_blank" rel="noopener" href="http://www.wch.cn/download/CH341SER_EXE.html">這裡</a>找到，下載後安裝就能辨識裝置了，開啟裝置管理員可以看到正確識別。</p>
<p><img src="https://i.imgur.com/fhzJ6zx.jpg" alt=""></p>
<p>重新啟動IDE，就能找到板子了。再來我們寫個簡單程序測試一下</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;Arduino.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> LED 2</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">setup</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="comment">// put your setup code here, to run once:</span></span><br><span class="line">  Serial.begin(<span class="number">115200</span>);</span><br><span class="line">  pinMode(LED, OUTPUT);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">loop</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="comment">// put your main code here, to run repeatedly:</span></span><br><span class="line">  digitalWrite(LED, HIGH);</span><br><span class="line">  Serial.println(<span class="string">&quot;LED is on&quot;</span>);</span><br><span class="line">  delay(<span class="number">1000</span>);</span><br><span class="line">  digitalWrite(LED, LOW);</span><br><span class="line">  Serial.println(<span class="string">&quot;LED is off&quot;</span>);</span><br><span class="line">  delay(<span class="number">1000</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p><img src="https://i.imgur.com/0FfNL4h.jpg" alt=""></p>
<p>編譯簡單程序卻報錯，Error: 2 UNKNOWN: exec: “cmd”: executable file not found in %PATH%，解決方式是將:\Windows\System32路徑加到環境變量裡，這個資料夾是cmd.exe的所在位置。添加完後重啟電腦。如果不想重啟，用管理員身分開啟cmd，輸入以下指令<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">taskkill &#x2F;f &#x2F;im explorer.exe</span><br><span class="line">explorer.exe</span><br></pre></td></tr></table></figure><br>輸入完後關閉cmd即可更新環境變數，重啟IDE就能抓到cmd了。</p>
<p>上傳後板子上的LED每格一秒會閃爍一次，並在Serial Monitor可以看到輸出的訊息。</p>
<p><img src="https://i.imgur.com/Dy4uQ82.jpg" alt=""></p>
<p><img src="https://i.imgur.com/GF7wfwd.jpg" alt=""></p>
<h2 id="撰寫天氣站軟體"><a href="#撰寫天氣站軟體" class="headerlink" title="撰寫天氣站軟體"></a>撰寫天氣站軟體</h2><h3 id="基本功能-結合BME280-TSL2591"><a href="#基本功能-結合BME280-TSL2591" class="headerlink" title="基本功能(結合BME280, TSL2591)"></a>基本功能(結合BME280, TSL2591)</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;Wire.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;Adafruit_Sensor.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;Adafruit_BME280.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;Adafruit_TSL2591.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> SEALEVELPRESSURE_HPA (1001.25) <span class="comment">// 1 atm = 1013.25 hPa</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> GAIN TSL2591_GAIN_MED <span class="comment">// (LOW, MID, HIGH)</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> INTEGRATIONTIME TSL2591_INTEGRATIONTIME_300MS <span class="comment">// (100MS,200MS,300MS,400MS,500MS,600MS)</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> DELAY_TIME 10000 <span class="comment">// interval time for every measurement (ms)</span></span></span><br><span class="line"></span><br><span class="line">Adafruit_BME280 bme; <span class="comment">//I2C</span></span><br><span class="line">Adafruit_TSL2591 tsl = Adafruit_TSL2591(<span class="number">2591</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">float</span> temp, humidity, pressure, altitude, luminosity;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">setup</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  Serial.begin(<span class="number">9600</span>);</span><br><span class="line"></span><br><span class="line">  init_bme280();</span><br><span class="line">  init_tsl2591();</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">loop</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  temp = get_temperature();</span><br><span class="line">  humidity = get_humidity();</span><br><span class="line">  pressure = get_pressure();</span><br><span class="line">  altitude = get_altitude();</span><br><span class="line">  luminosity = get_luminosity();</span><br><span class="line"></span><br><span class="line">  Serial.print(<span class="string">&quot;Temp: &quot;</span>); Serial.print(temp); Serial.println(<span class="string">&quot;*C&quot;</span>);</span><br><span class="line">  Serial.print(<span class="string">&quot;Humid: &quot;</span>); Serial.print(humidity); Serial.println(<span class="string">&quot;%&quot;</span>);</span><br><span class="line">  Serial.print(<span class="string">&quot;Pressure: &quot;</span>); Serial.print(pressure/<span class="number">100.0</span>); Serial.println(<span class="string">&quot;hPa&quot;</span>);</span><br><span class="line">  Serial.print(<span class="string">&quot;Alt: &quot;</span>); Serial.print(altitude); Serial.println(<span class="string">&quot;m&quot;</span>);</span><br><span class="line">  Serial.print(<span class="string">&quot;Lumin: &quot;</span>); Serial.print(luminosity); Serial.println(<span class="string">&quot;lux&quot;</span>);</span><br><span class="line">  Serial.println(<span class="string">&quot;&quot;</span>);</span><br><span class="line">  delay(DELAY_TIME);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">init_bme280</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  bme.begin(<span class="number">0x76</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">init_tsl2591</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  tsl.begin(<span class="number">0x29</span>);</span><br><span class="line">  tsl.setGain(GAIN);</span><br><span class="line">  tsl.setTiming(INTEGRATIONTIME);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">float</span> <span class="title">get_temperature</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> bme.readTemperature();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">float</span> <span class="title">get_humidity</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> bme.readHumidity();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">float</span> <span class="title">get_altitude</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> bme.readAltitude(SEALEVELPRESSURE_HPA);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">float</span> <span class="title">get_pressure</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> bme.readPressure();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">float</span> <span class="title">get_luminosity</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="keyword">uint32_t</span> lum = tsl.getFullLuminosity();</span><br><span class="line">  <span class="keyword">uint16_t</span> ir,full;</span><br><span class="line">  ir = lum &gt;&gt; <span class="number">16</span>;</span><br><span class="line">  full = lum &amp; <span class="number">0xFFFF</span>;</span><br><span class="line">  <span class="keyword">return</span> tsl.calculateLux(full, ir); <span class="comment">// return -1 if the value blows up</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>程式碼中define了幾個常量<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> SEALEVELPRESSURE_HPA (1001.25) <span class="comment">// 1 atm = 1013.25 hPa</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> GAIN TSL2591_GAIN_HIGH <span class="comment">// (LOW, MID, HIGH)</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> INTEGRATIONTIME TSL2591_INTEGRATIONTIME_600MS <span class="comment">// (100MS,200MS,300MS,400MS,500MS,600MS)</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> DELAY_TIME 10000 <span class="comment">// interval time for every measurement (ms)</span></span></span><br></pre></td></tr></table></figure><br>首先第一行定義了海平面的氣壓，為了計算高度用(高度計算的原理是測量氣壓減去海平面氣壓，高度升高10m約降低1hPa)，可以從氣象局官網查詢，也能設為一大氣壓。第二行是TSL2591的Gain，由於我們要測量黑暗天空的品質(SQM)，因此將Gain調成HIGH來測量極低環境下的光源，另外也將INTEGRATIONTIME調到最長。第四行則代表每30秒測量一次數據，這裡要注意<strong>溫溼度測量的採樣頻率不要太高，避免感測器升溫影響數據</strong>。</p>
<div class="note warning modern"><p>官方建議量測間隔不要低於1秒，否則感測器可能會受到電流加熱影響</p>
</div>
<p><img src="https://i.imgur.com/QSywy04.jpg" alt=""></p>
<h3 id="將數據顯示在TFT螢幕上"><a href="#將數據顯示在TFT螢幕上" class="headerlink" title="將數據顯示在TFT螢幕上"></a>將數據顯示在TFT螢幕上</h3><p>大部分的功能可以參照上方寫的，這裡要注意的是這次選的螢幕解析度只有160x128，因此要衡量一下版面怎麼配置，才能最好的顯示出來。比較困難的是顯示圖片，這次我打算在螢幕上顯示幾個不同的icon，因此需要用到Adafruit GFX函式庫裡的drawBitmap()。詳細教學可以參考這部<a target="_blank" rel="noopener" href="https://www.youtube.com/watch?v=7ER1fbDoc20">影片</a>，我在與程式碼同個資料夾下建立新檔案<code>icon.c</code>，內容如下</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// icon.c</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;pgmspace.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="keyword">unsigned</span> <span class="keyword">char</span> icon_temp[] PROGMEM = &#123;</span><br><span class="line">  <span class="number">0x00</span>,<span class="number">0x07</span>,<span class="number">0xE0</span>,<span class="number">0x00</span>,</span><br><span class="line">  <span class="number">0x00</span>,<span class="number">0x0E</span>,<span class="number">0x70</span>,<span class="number">0x00</span>,</span><br><span class="line">  <span class="number">0x00</span>,<span class="number">0x18</span>,<span class="number">0x18</span>,<span class="number">0x00</span>,</span><br><span class="line">  <span class="number">0x00</span>,<span class="number">0x11</span>,<span class="number">0x88</span>,<span class="number">0x00</span>,</span><br><span class="line">  <span class="number">0x01</span>,<span class="number">0x93</span>,<span class="number">0xC9</span>,<span class="number">0x80</span>,</span><br><span class="line">  <span class="number">0x01</span>,<span class="number">0xF2</span>,<span class="number">0x4F</span>,<span class="number">0x80</span>,</span><br><span class="line">  <span class="number">0x00</span>,<span class="number">0x32</span>,<span class="number">0x4C</span>,<span class="number">0x00</span>,</span><br><span class="line">  <span class="number">0x00</span>,<span class="number">0x32</span>,<span class="number">0x4C</span>,<span class="number">0x00</span>,</span><br><span class="line">  <span class="number">0x07</span>,<span class="number">0xB2</span>,<span class="number">0x4D</span>,<span class="number">0xE0</span>,</span><br><span class="line">  <span class="number">0x07</span>,<span class="number">0xF2</span>,<span class="number">0x4F</span>,<span class="number">0xE0</span>,</span><br><span class="line">  <span class="number">0x00</span>,<span class="number">0x32</span>,<span class="number">0x4C</span>,<span class="number">0x00</span>,</span><br><span class="line">  <span class="number">0x00</span>,<span class="number">0x32</span>,<span class="number">0x4C</span>,<span class="number">0x00</span>,</span><br><span class="line">  <span class="number">0x01</span>,<span class="number">0xB3</span>,<span class="number">0xC9</span>,<span class="number">0x80</span>,</span><br><span class="line">  <span class="number">0x01</span>,<span class="number">0xB3</span>,<span class="number">0xC1</span>,<span class="number">0x80</span>,</span><br><span class="line">  <span class="number">0x00</span>,<span class="number">0x32</span>,<span class="number">0x40</span>,<span class="number">0x00</span>,</span><br><span class="line">  <span class="number">0x00</span>,<span class="number">0x32</span>,<span class="number">0x48</span>,<span class="number">0x00</span>,</span><br><span class="line">  <span class="number">0x07</span>,<span class="number">0xB2</span>,<span class="number">0x41</span>,<span class="number">0xE0</span>,</span><br><span class="line">  <span class="number">0x07</span>,<span class="number">0xB2</span>,<span class="number">0x49</span>,<span class="number">0xE0</span>,</span><br><span class="line">  <span class="number">0x00</span>,<span class="number">0x32</span>,<span class="number">0x4C</span>,<span class="number">0x00</span>,</span><br><span class="line">  <span class="number">0x00</span>,<span class="number">0x32</span>,<span class="number">0x4C</span>,<span class="number">0x00</span>,</span><br><span class="line">  <span class="number">0x00</span>,<span class="number">0x62</span>,<span class="number">0x46</span>,<span class="number">0x00</span>,</span><br><span class="line">  <span class="number">0x00</span>,<span class="number">0x46</span>,<span class="number">0x62</span>,<span class="number">0x00</span>,</span><br><span class="line">  <span class="number">0x00</span>,<span class="number">0xCC</span>,<span class="number">0x33</span>,<span class="number">0x00</span>,</span><br><span class="line">  <span class="number">0x00</span>,<span class="number">0xC8</span>,<span class="number">0x13</span>,<span class="number">0x00</span>,</span><br><span class="line">  <span class="number">0x00</span>,<span class="number">0xC8</span>,<span class="number">0x13</span>,<span class="number">0x00</span>,</span><br><span class="line">  <span class="number">0x00</span>,<span class="number">0xC8</span>,<span class="number">0x13</span>,<span class="number">0x00</span>,</span><br><span class="line">  <span class="number">0x00</span>,<span class="number">0xCC</span>,<span class="number">0x33</span>,<span class="number">0x00</span>,</span><br><span class="line">  <span class="number">0x00</span>,<span class="number">0x67</span>,<span class="number">0xE6</span>,<span class="number">0x00</span>,</span><br><span class="line">  <span class="number">0x00</span>,<span class="number">0x63</span>,<span class="number">0xC6</span>,<span class="number">0x00</span>,</span><br><span class="line">  <span class="number">0x00</span>,<span class="number">0x30</span>,<span class="number">0x0C</span>,<span class="number">0x00</span>,</span><br><span class="line">  <span class="number">0x00</span>,<span class="number">0x1C</span>,<span class="number">0x38</span>,<span class="number">0x00</span>,</span><br><span class="line">  <span class="number">0x00</span>,<span class="number">0x07</span>,<span class="number">0xE0</span>,<span class="number">0x00</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>裡面是用陣列存放每個像素的值，關於將圖片轉成陣列，可以使用這個<a target="_blank" rel="noopener" href="https://marlinfw.org/tools/u8glib/converter.html">網站</a>。注意第一行的<code>#include &lt;pgmspace.h&gt;</code>要寫，因為ESP32的RAM很小，加上這行讓這些圖片陣列能使用空間較大的program memory。</p>
<p><img src="https://i.imgur.com/wZ1XwiT.jpg" alt=""></p>
<p>經過完一番調整，終於完成了基本的版面，上面顯示各種數值，分別是溫度、SQM數值、濕度、氣壓、露點溫度以及海拔。我設定成10秒更新一次，在螢幕刷新上我注意到螢幕會有閃爍問題，因為每次刷新都需要將整個螢幕塗黑再一一畫上去，加上響應速度不快，導致閃爍(Flickering)。如果不使用自訂字型，去用預設的字型的話，可以只更新數字的部分，而不是將整張畫面重畫，能大幅降低閃爍情形，可惜預設字型很醜且大小不適合。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;math.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;Wire.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;SPI.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;Adafruit_Sensor.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;Adafruit_BME280.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;Adafruit_TSL2591.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;Adafruit_GFX.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;Adafruit_ST7735.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;Fonts/FreeSans9pt7b.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> SEALEVELPRESSURE_HPA 1003.0 <span class="comment">// 1 atm = 1013.25 hPa</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> GAIN TSL2591_GAIN_HIGH <span class="comment">// (LOW, MID, HIGH)</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> INTEGRATIONTIME TSL2591_INTEGRATIONTIME_500MS <span class="comment">// (100MS,200MS,300MS,400MS,500MS,600MS)</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> EFFECTIVE_SOLID_ANGLE 1.532 <span class="comment">// solid angle in steradians for SQM</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> DELAY_TIME 10000 <span class="comment">// interval time for every measurement</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> TFT_CS   5 </span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> TFT_DC   17</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> TFT_RST  0</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> TFT_Vcc  16</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> BLACK   0x0000</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> BLUE    0x001F</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> RED     0xF800</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> GREEN   0x07E0</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CYAN    0x07FF</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MAGENTA 0xF81F</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> YELLOW  0xFFE0</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> WHITE   0xFFFF</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> GREY     0xD6BA</span></span><br><span class="line"></span><br><span class="line">Adafruit_BME280 bme; <span class="comment">//I2C</span></span><br><span class="line">Adafruit_TSL2591 tsl = Adafruit_TSL2591(<span class="number">2591</span>);</span><br><span class="line">Adafruit_ST7735 tft = Adafruit_ST7735(TFT_CS, TFT_DC, TFT_RST);</span><br><span class="line"></span><br><span class="line"><span class="keyword">float</span> temp, humidity, pressure, altitude, luminosity, dewpoint, SQM;</span><br><span class="line"></span><br><span class="line"><span class="comment">// icon&#x27;s bitmap</span></span><br><span class="line"><span class="keyword">extern</span> <span class="keyword">uint8_t</span> icon_temp[];</span><br><span class="line"><span class="keyword">extern</span> <span class="keyword">uint8_t</span> icon_humidity[];</span><br><span class="line"><span class="keyword">extern</span> <span class="keyword">uint8_t</span> icon_pressure[];</span><br><span class="line"><span class="keyword">extern</span> <span class="keyword">uint8_t</span> icon_SQM[];</span><br><span class="line"><span class="keyword">extern</span> <span class="keyword">uint8_t</span> icon_dew[];</span><br><span class="line"><span class="keyword">extern</span> <span class="keyword">uint8_t</span> icon_altitude[];</span><br><span class="line"><span class="keyword">extern</span> <span class="keyword">uint8_t</span> icon_wifi[];</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">setup</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  Serial.begin(<span class="number">9600</span>);</span><br><span class="line"></span><br><span class="line">  pinMode(TFT_Vcc, OUTPUT);</span><br><span class="line">  digitalWrite(TFT_Vcc, <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">  init_bme280();</span><br><span class="line">  init_tsl2591();</span><br><span class="line">  init_tft();</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">loop</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  temp = get_temperature();</span><br><span class="line">  humidity = get_humidity();</span><br><span class="line">  pressure = get_pressure();</span><br><span class="line">  altitude = get_altitude();</span><br><span class="line">  luminosity = get_luminosity();</span><br><span class="line"></span><br><span class="line">  dewpoint = temp - ((<span class="number">100</span>-humidity)/<span class="number">5.</span>); <span class="comment">// calculate dew point</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">//calculate SQM</span></span><br><span class="line">  SQM = log10f((luminosity/EFFECTIVE_SOLID_ANGLE)/<span class="number">108000</span>)/(<span class="number">-0.4</span>);</span><br><span class="line"></span><br><span class="line">  update_tft(temp, humidity, pressure, altitude, luminosity, dewpoint);</span><br><span class="line"></span><br><span class="line">  Serial.print(<span class="string">&quot;Temp: &quot;</span>); Serial.print(temp); Serial.println(<span class="string">&quot;*C&quot;</span>);</span><br><span class="line">  Serial.print(<span class="string">&quot;SQM: &quot;</span>); Serial.print(SQM); Serial.println(<span class="string">&quot;Mag/as^2&quot;</span>);</span><br><span class="line">  Serial.print(<span class="string">&quot;Humid: &quot;</span>); Serial.print(humidity); Serial.println(<span class="string">&quot;%&quot;</span>);</span><br><span class="line">  Serial.print(<span class="string">&quot;Pressure: &quot;</span>); Serial.print(pressure); Serial.println(<span class="string">&quot;hPa&quot;</span>);</span><br><span class="line">  Serial.print(<span class="string">&quot;Alt: &quot;</span>); Serial.print(altitude); Serial.println(<span class="string">&quot;m&quot;</span>);</span><br><span class="line">  Serial.print(<span class="string">&quot;DewPoint: &quot;</span>); Serial.print(dewpoint); Serial.println(<span class="string">&quot;*C&quot;</span>);</span><br><span class="line">  Serial.print(<span class="string">&quot;Lumin: &quot;</span>); Serial.print(luminosity); Serial.println(<span class="string">&quot;lux&quot;</span>);</span><br><span class="line">  Serial.println(<span class="string">&quot;&quot;</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  delay(DELAY_TIME);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">init_bme280</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  bme.begin(<span class="number">0x76</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">init_tsl2591</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  tsl.begin(<span class="number">0x29</span>);</span><br><span class="line">  tsl.setGain(GAIN);</span><br><span class="line">  tsl.setTiming(INTEGRATIONTIME);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">init_tft</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  tft.initR(INITR_BLACKTAB); <span class="comment">// for 1.8&quot; ST7735 TFT display</span></span><br><span class="line">  tft.setRotation(<span class="number">1</span>);  <span class="comment">//screen rotation</span></span><br><span class="line">  tft.setTextWrap(<span class="literal">false</span>);</span><br><span class="line">  tft.fillScreen(ST77XX_BLACK);  <span class="comment">//filled with black color</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">float</span> <span class="title">get_temperature</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> bme.readTemperature();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">float</span> <span class="title">get_humidity</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> bme.readHumidity();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">float</span> <span class="title">get_altitude</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> bme.readAltitude(SEALEVELPRESSURE_HPA);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">float</span> <span class="title">get_pressure</span><span class="params">()</span> </span>&#123; <span class="comment">// return hPa</span></span><br><span class="line">  <span class="keyword">return</span> bme.readPressure()/<span class="number">100.0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">float</span> <span class="title">get_luminosity</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="keyword">uint32_t</span> lum = tsl.getFullLuminosity();</span><br><span class="line">  <span class="keyword">uint16_t</span> ir,full;</span><br><span class="line">  ir = lum &gt;&gt; <span class="number">16</span>;</span><br><span class="line">  full = lum &amp; <span class="number">0xFFFF</span>;</span><br><span class="line">  <span class="keyword">return</span> tsl.calculateLux(full, ir); <span class="comment">// return -1 if the value blows up</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">update_tft</span><span class="params">(<span class="keyword">float</span> temp, <span class="keyword">float</span> humidity, <span class="keyword">float</span> pressure, <span class="keyword">float</span> altitude, <span class="keyword">float</span> luminosity, <span class="keyword">float</span> dewpoint)</span> </span>&#123;</span><br><span class="line">  tft.fillScreen(ST77XX_BLACK);</span><br><span class="line">  tft.setFont(&amp;FreeSans9pt7b);</span><br><span class="line"></span><br><span class="line">  tft.setCursor(<span class="number">4</span>, <span class="number">18</span>);</span><br><span class="line">  tft.setTextColor(ST77XX_WHITE);</span><br><span class="line">  tft.print(<span class="string">&quot;Weather Station&quot;</span>);</span><br><span class="line">  tft.drawBitmap(<span class="number">140</span>, <span class="number">4</span>, icon_wifi, <span class="number">16</span>, <span class="number">16</span>, GREEN);</span><br><span class="line">  tft.drawLine(<span class="number">0</span>, <span class="number">24</span>, <span class="number">160</span>, <span class="number">24</span>, WHITE);</span><br><span class="line"></span><br><span class="line">  tft.drawBitmap(<span class="number">0</span>, <span class="number">32</span>, icon_temp, <span class="number">24</span>, <span class="number">24</span>, WHITE);</span><br><span class="line">  tft.setCursor(<span class="number">26</span>, <span class="number">47</span>);</span><br><span class="line">  tft.setTextColor(ST77XX_WHITE);</span><br><span class="line">  tft.print(temp);</span><br><span class="line">  tft.setFont(<span class="literal">NULL</span>); tft.setCursor(<span class="number">72</span>,<span class="number">50</span>); tft.print(<span class="string">&quot;C&quot;</span>); tft.setFont(&amp;FreeSans9pt7b);</span><br><span class="line"></span><br><span class="line">  tft.drawBitmap(<span class="number">80</span>, <span class="number">32</span>, icon_SQM, <span class="number">24</span>, <span class="number">24</span>, WHITE);</span><br><span class="line">  tft.setCursor(<span class="number">106</span>, <span class="number">46</span>);</span><br><span class="line">  tft.setTextColor(ST77XX_WHITE);</span><br><span class="line">  tft.print(SQM);</span><br><span class="line">  tft.setFont(<span class="literal">NULL</span>); tft.setCursor(<span class="number">108</span>,<span class="number">49</span>); tft.print(<span class="string">&quot;Mag/as2&quot;</span>); tft.setFont(&amp;FreeSans9pt7b);</span><br><span class="line"></span><br><span class="line">  tft.drawBitmap(<span class="number">0</span>, <span class="number">66</span>, icon_humidity, <span class="number">24</span>, <span class="number">24</span>, WHITE);</span><br><span class="line">  tft.setCursor(<span class="number">26</span>, <span class="number">84</span>);</span><br><span class="line">  tft.setTextColor(ST77XX_WHITE);</span><br><span class="line">  tft.print(humidity);</span><br><span class="line">  tft.setFont(<span class="literal">NULL</span>); tft.setCursor(<span class="number">72</span>,<span class="number">88</span>); tft.print(<span class="string">&quot;%&quot;</span>); tft.setFont(&amp;FreeSans9pt7b);</span><br><span class="line"></span><br><span class="line">  tft.drawBitmap(<span class="number">80</span>, <span class="number">66</span>, icon_pressure, <span class="number">24</span>, <span class="number">24</span>, WHITE);</span><br><span class="line">  tft.setCursor(<span class="number">105</span>, <span class="number">84</span>);</span><br><span class="line">  tft.setTextColor(ST77XX_WHITE);</span><br><span class="line">  tft.print(pressure, <span class="number">1</span>);</span><br><span class="line">  tft.setFont(<span class="literal">NULL</span>); tft.setCursor(<span class="number">140</span>,<span class="number">88</span>); tft.print(<span class="string">&quot;hPa&quot;</span>); tft.setFont(&amp;FreeSans9pt7b);</span><br><span class="line"></span><br><span class="line">  tft.drawBitmap(<span class="number">0</span>, <span class="number">100</span>, icon_dew, <span class="number">24</span>, <span class="number">24</span>, WHITE);</span><br><span class="line">  tft.setCursor(<span class="number">26</span>, <span class="number">117</span>);</span><br><span class="line">  tft.setTextColor(ST77XX_WHITE);</span><br><span class="line">  tft.print(dewpoint);</span><br><span class="line">  tft.setFont(<span class="literal">NULL</span>); tft.setCursor(<span class="number">72</span>,<span class="number">120</span>); tft.print(<span class="string">&quot;C&quot;</span>); tft.setFont(&amp;FreeSans9pt7b);</span><br><span class="line"></span><br><span class="line">  tft.drawBitmap(<span class="number">80</span>, <span class="number">100</span>, icon_altitude, <span class="number">24</span>, <span class="number">24</span>, WHITE);</span><br><span class="line">  tft.setCursor(<span class="number">105</span>, <span class="number">117</span>);</span><br><span class="line">  tft.setTextColor(ST77XX_WHITE);</span><br><span class="line">  tft.print(altitude);</span><br><span class="line">  tft.setFont(<span class="literal">NULL</span>); tft.setCursor(<span class="number">152</span>,<span class="number">119</span>); tft.print(<span class="string">&quot;m&quot;</span>); tft.setFont(&amp;FreeSans9pt7b);</span><br><span class="line">  </span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p><img src="https://i.imgur.com/VKgriCL.jpg" alt=""></p>
<p>裡面有透過溫溼度去換算露點溫度，以及SQM數值的計算。</p>
<h3 id="露點溫度及SQM數值計算"><a href="#露點溫度及SQM數值計算" class="headerlink" title="露點溫度及SQM數值計算"></a>露點溫度及SQM數值計算</h3><h4 id="露點溫度"><a href="#露點溫度" class="headerlink" title="露點溫度"></a>露點溫度</h4><p>當環境溫度低於露點溫度時，空氣中的水氣就會凝結，這對進行天文攝影的人來說影響很大，有可能會讓相機和望遠鏡進水，因此新增了這一項有用的資訊，露點溫度能從溫度和濕度去計算，較簡單的近似是</p>
<script type="math/tex; mode=display">
T_{d} = T - (100-RH)/5</script><p>$T_{d}$是露點溫度，$T$是環境溫度，$RH$是相對溼度，這條近似的式子在濕度50%以上的誤差可以小於+-1度，算是很好的準確度。</p>
<h4 id="SQM數值"><a href="#SQM數值" class="headerlink" title="SQM數值"></a>SQM數值</h4><p>SQM數值是科學家提出來用來測量夜空天空背景亮度的單位，單位是$Magnitude/arcsec^{2}$，單位面積下的亮度。一般來說業餘天文家會用加拿大公司 Unihedron 生產的 SQM (Sky Quality Meter) 來測量SQM數值，這種儀器價格約落在119~135美元，出廠都有經過儀器校正，且體積小方便攜帶，我自己也有一台，去戶外觀星時都會隨時測量天空亮度，來衡量光害汙染程度。</p>
<p><img src="https://i.imgur.com/5BJCjsg.jpg" alt=""></p>
<p><img src="https://i.imgur.com/TCme7GZ.jpg" alt=""></p>
<p>偵測器上藍藍一片的是UV-IR截止濾鏡，用來濾掉紅外和紫外光，只允許可見光通過，以符合肉眼目視的範圍。裡面用的光感測器是TSL237S-LF，偵測暗光能力不錯，但因年代久遠，目前很難找到貨源。</p>
<p>網路上搜尋光害地圖，就能看到世界各地光害汙染程度，這些測量就是以SQM數值去統計和繪製，台灣的鹿林天文台，合歡山暗光公園，都有SQM監測裝置，可以研究當地的光汙染變化。</p>
<p><img src="https://i.imgur.com/ubdy9ej.jpg" alt=""></p>
<p>SQM數值的計算可以從光照度(lux)來換算，首先要先將光照度(Illuminance)換成光度(luminance)</p>
<script type="math/tex; mode=display">
1 lux = 1 sr \cdot cd/m^{2}</script><p>其中$sr$是立體角(solid angle)，這個角度與你感測器所能偵測的張角有關，一般SQM機器會偵測天空直徑範圍80度的區域，這區域裡的光會進到感測器裡，而附有鏡頭的SQM-L，則是偵測10度範圍的天空。<a target="_blank" rel="noopener" href="http://www.unihedron.com/projects/darksky/faqsqm.php">官網</a>有提到它們販售的SQM的立體角是1.532sr，根據儀器設計不同，這個立體角也會不同。</p>
<script type="math/tex; mode=display">
    SQM\text{ }Brightness = -log_{10}([\text{value in cd/m2}]/108000)/0.4</script><p>上面的公式就是SQM數值的定義，一般的夜空亮度數值落在16~22，我先前去鹿林天文台的時候，有量到超過22的數值，光害極小，能輕易看見銀河和數不盡的星星。</p>
<p>第一次測出來的結果與我手邊的SQM儀器相差不遠，但是仍需要校正，等到做好了外殼，到時修改預設的立體角就能校正了，要注意光感測元件不要傾斜，盡量與開口平行，否會導致測到的光大幅下降，失去準度。</p>
<h3 id="網路-IoT-功能"><a href="#網路-IoT-功能" class="headerlink" title="網路(IoT)功能"></a>網路(IoT)功能</h3><p>這台NodeMCU-32S最特別的就是它有內建Wi-Fi和藍芽晶片，當然要讓我們測到的資料有能力傳送到網路上阿。接下來將介紹這台的連網功能，並結合Adafruit來達成網頁監測數據的功能。</p>
<p>首先先安裝MQTT函式庫</p>
<p><img src="https://i.imgur.com/FMTyc3L.jpg" alt=""></p>
<p><img src="https://i.imgur.com/SyuYL9S.jpg" alt=""></p>
<p><img src="https://i.imgur.com/muiOqI6.jpg" alt=""></p>
<p><img src="https://i.imgur.com/jkioXiv.jpg" alt=""></p>
<p><img src="https://i.imgur.com/2o4dvsG.jpg" alt=""></p>
<p><img src="https://i.imgur.com/TQHuCh3.jpg" alt=""></p>
<p><img src="https://i.imgur.com/JXA1lIv.jpg" alt=""></p>
<p><img src="https://i.imgur.com/LGiLgwy.jpg" alt=""></p>
<p>從feed頁面查看名稱，點開後看網址後綴，<strong>feed名稱的空格會被-替換掉，大寫變成小寫，需要注意</strong>。這裡的名稱就是我們要寫入程式碼的feed名稱。</p>
<p><img src="https://i.imgur.com/4ZHcSa6.jpg" alt=""></p>
<p><img src="https://i.imgur.com/ZpJeUCy.jpg" alt=""></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;math.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;Wire.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;SPI.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;Adafruit_Sensor.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;Adafruit_BME280.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;Adafruit_TSL2591.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;Adafruit_GFX.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;Adafruit_ST7735.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;Fonts/FreeSans9pt7b.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;WiFi.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;Adafruit_MQTT.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;Adafruit_MQTT_Client.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">//Wi-Fi parameters</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> WLAN_SSID <span class="meta-string">&quot;Wooster&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> WLAN_PASSWD <span class="meta-string">&quot;123456789&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> WLAN_TIMEOUT_MS 15000</span></span><br><span class="line"><span class="comment">// Adafruit IO</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> AIO_SERVER <span class="meta-string">&quot;io.adafruit.com&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> AIO_SERVERPORT 1883</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> AIO_USERNAME <span class="meta-string">&quot;jamiechang917&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> AIO_KEY <span class="meta-string">&quot;填入你的金鑰(key)&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> SEALEVELPRESSURE_HPA 1003.0 <span class="comment">// 1 atm = 1013.25 hPa</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> GAIN TSL2591_GAIN_HIGH <span class="comment">// (LOW, MID, HIGH)</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> INTEGRATIONTIME TSL2591_INTEGRATIONTIME_500MS <span class="comment">// (100MS,200MS,300MS,400MS,500MS,600MS)</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> EFFECTIVE_SOLID_ANGLE 1.532 <span class="comment">// solid angle in steradians for SQM</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> SCREEN_REFRESH_TIME 10 <span class="comment">// (second) refresh the screen every 10 seconds</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> SEND_DATA_TIME 15 <span class="comment">// (second) send data to adafruit io every 15 seconds</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> TFT_CS   5 </span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> TFT_DC   17</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> TFT_RST  0</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> TFT_Vcc  16</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> BLACK   0x0000</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> BLUE    0x001F</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> RED     0xF800</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> GREEN   0x07E0</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CYAN    0x07FF</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MAGENTA 0xF81F</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> YELLOW  0xFFE0</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> WHITE   0xFFFF</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> GREY     0xD6BA</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//Setup the WiFi and MQTT client</span></span><br><span class="line">WiFiClient client;</span><br><span class="line"><span class="function">Adafruit_MQTT_Client <span class="title">mqtt</span><span class="params">(&amp;client, AIO_SERVER, AIO_SERVERPORT, AIO_USERNAME, AIO_KEY)</span></span>;</span><br><span class="line">Adafruit_MQTT_Publish AIO_temp = Adafruit_MQTT_Publish(&amp;mqtt, AIO_USERNAME <span class="string">&quot;/feeds/temperature&quot;</span>);</span><br><span class="line">Adafruit_MQTT_Publish AIO_humidity = Adafruit_MQTT_Publish(&amp;mqtt, AIO_USERNAME <span class="string">&quot;/feeds/humidity&quot;</span>);</span><br><span class="line">Adafruit_MQTT_Publish AIO_SQM = Adafruit_MQTT_Publish(&amp;mqtt, AIO_USERNAME <span class="string">&quot;/feeds/sqm&quot;</span>);</span><br><span class="line">Adafruit_MQTT_Publish AIO_pressure = Adafruit_MQTT_Publish(&amp;mqtt, AIO_USERNAME <span class="string">&quot;/feeds/pressure&quot;</span>);</span><br><span class="line">Adafruit_MQTT_Publish AIO_altitude = Adafruit_MQTT_Publish(&amp;mqtt, AIO_USERNAME <span class="string">&quot;/feeds/altitude&quot;</span>);</span><br><span class="line">Adafruit_MQTT_Publish AIO_dewpoint = Adafruit_MQTT_Publish(&amp;mqtt, AIO_USERNAME <span class="string">&quot;/feeds/dew-point&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// setup the sensors</span></span><br><span class="line">Adafruit_BME280 bme; <span class="comment">//I2C</span></span><br><span class="line">Adafruit_TSL2591 tsl = Adafruit_TSL2591(<span class="number">2591</span>);</span><br><span class="line">Adafruit_ST7735 tft = Adafruit_ST7735(TFT_CS, TFT_DC, TFT_RST);</span><br><span class="line"></span><br><span class="line"><span class="keyword">float</span> temp, humidity, pressure, altitude, luminosity, dewpoint, SQM;</span><br><span class="line"></span><br><span class="line"><span class="keyword">int</span> refresh_cnt = <span class="number">0</span>, send_cnt = <span class="number">0</span>; </span><br><span class="line"></span><br><span class="line"><span class="comment">// icon&#x27;s bitmap</span></span><br><span class="line"><span class="keyword">extern</span> <span class="keyword">uint8_t</span> icon_temp[];</span><br><span class="line"><span class="keyword">extern</span> <span class="keyword">uint8_t</span> icon_humidity[];</span><br><span class="line"><span class="keyword">extern</span> <span class="keyword">uint8_t</span> icon_pressure[];</span><br><span class="line"><span class="keyword">extern</span> <span class="keyword">uint8_t</span> icon_SQM[];</span><br><span class="line"><span class="keyword">extern</span> <span class="keyword">uint8_t</span> icon_dew[];</span><br><span class="line"><span class="keyword">extern</span> <span class="keyword">uint8_t</span> icon_altitude[];</span><br><span class="line"><span class="keyword">extern</span> <span class="keyword">uint8_t</span> icon_wifi[];</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">setup</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  Serial.begin(<span class="number">9600</span>);</span><br><span class="line"></span><br><span class="line">  pinMode(TFT_Vcc, OUTPUT);</span><br><span class="line">  digitalWrite(TFT_Vcc, <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">  init_bme280();</span><br><span class="line">  init_tsl2591();</span><br><span class="line">  init_tft();</span><br><span class="line">  measure();</span><br><span class="line">  update_tft(temp, humidity, pressure, altitude, dewpoint, SQM);</span><br><span class="line"></span><br><span class="line">  connect_wifi();</span><br><span class="line">  connect_adafruit();</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">loop</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">if</span> (refresh_cnt &gt;= SCREEN_REFRESH_TIME) &#123;</span><br><span class="line">    refresh_cnt = <span class="number">0</span>;</span><br><span class="line">    measure();</span><br><span class="line">    update_tft(temp, humidity, pressure, altitude, dewpoint, SQM);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (send_cnt &gt;= SEND_DATA_TIME) &#123;</span><br><span class="line">    send_cnt = <span class="number">0</span>;</span><br><span class="line">    measure();</span><br><span class="line">    <span class="comment">// send data to adafruit io</span></span><br><span class="line">    <span class="keyword">if</span> (!mqtt.connected()) &#123; <span class="comment">// reconnect when disconnecting</span></span><br><span class="line">      Serial.println(<span class="string">&quot;Reconnecting...&quot;</span>);</span><br><span class="line">      connect_wifi();</span><br><span class="line">      connect_adafruit();</span><br><span class="line">    &#125;</span><br><span class="line">    send_data(temp, humidity, pressure, altitude, dewpoint, SQM);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  refresh_cnt += <span class="number">1</span>;</span><br><span class="line">  send_cnt += <span class="number">1</span>;</span><br><span class="line">  delay(<span class="number">1000</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">init_bme280</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  bme.begin(<span class="number">0x76</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">init_tsl2591</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  tsl.begin(<span class="number">0x29</span>);</span><br><span class="line">  tsl.setGain(GAIN);</span><br><span class="line">  tsl.setTiming(INTEGRATIONTIME);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">init_tft</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  tft.initR(INITR_BLACKTAB); <span class="comment">// for 1.8&quot; ST7735 TFT display</span></span><br><span class="line">  tft.setRotation(<span class="number">1</span>);  <span class="comment">//screen rotation</span></span><br><span class="line">  tft.setTextWrap(<span class="literal">false</span>);</span><br><span class="line">  tft.fillScreen(ST77XX_BLACK);  <span class="comment">//filled with black color</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">float</span> <span class="title">get_temperature</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> bme.readTemperature();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">float</span> <span class="title">get_humidity</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> bme.readHumidity();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">float</span> <span class="title">get_altitude</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> bme.readAltitude(SEALEVELPRESSURE_HPA);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">float</span> <span class="title">get_pressure</span><span class="params">()</span> </span>&#123; <span class="comment">// return hPa</span></span><br><span class="line">  <span class="keyword">return</span> bme.readPressure()/<span class="number">100.0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">float</span> <span class="title">get_luminosity</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="keyword">uint32_t</span> lum = tsl.getFullLuminosity();</span><br><span class="line">  <span class="keyword">uint16_t</span> ir,full;</span><br><span class="line">  ir = lum &gt;&gt; <span class="number">16</span>;</span><br><span class="line">  full = lum &amp; <span class="number">0xFFFF</span>;</span><br><span class="line">  <span class="keyword">return</span> tsl.calculateLux(full, ir); <span class="comment">// return -1 if the value blows up</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">measure</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  temp = get_temperature();</span><br><span class="line">  humidity = get_humidity();</span><br><span class="line">  pressure = get_pressure();</span><br><span class="line">  altitude = get_altitude();</span><br><span class="line">  luminosity = get_luminosity();</span><br><span class="line"></span><br><span class="line">  <span class="comment">// calculate dew point</span></span><br><span class="line">  dewpoint = temp - ((<span class="number">100</span>-humidity)/<span class="number">5.</span>);</span><br><span class="line">  <span class="comment">// calculate SQM</span></span><br><span class="line">  SQM = log10f((luminosity/EFFECTIVE_SOLID_ANGLE)/<span class="number">108000</span>)/(<span class="number">-0.4</span>);</span><br><span class="line"></span><br><span class="line">  Serial.println(<span class="string">&quot;=============Measurement=============&quot;</span>);</span><br><span class="line">  Serial.print(<span class="string">&quot;Temperature:\t&quot;</span>); Serial.print(temp); Serial.println(<span class="string">&quot; C&quot;</span>);</span><br><span class="line">  Serial.print(<span class="string">&quot;SQM:\t&quot;</span>); Serial.print(SQM); Serial.println(<span class="string">&quot; Mag/as^2&quot;</span>);</span><br><span class="line">  Serial.print(<span class="string">&quot;Humidity:\t&quot;</span>); Serial.print(humidity); Serial.println(<span class="string">&quot; %&quot;</span>);</span><br><span class="line">  Serial.print(<span class="string">&quot;Pressure:\t&quot;</span>); Serial.print(pressure); Serial.println(<span class="string">&quot; hPa&quot;</span>);</span><br><span class="line">  Serial.print(<span class="string">&quot;Altitude:\t&quot;</span>); Serial.print(altitude); Serial.println(<span class="string">&quot; m&quot;</span>);</span><br><span class="line">  Serial.print(<span class="string">&quot;Dew Point:\t&quot;</span>); Serial.print(dewpoint); Serial.println(<span class="string">&quot; C&quot;</span>);</span><br><span class="line">  Serial.print(<span class="string">&quot;Illuminance:\t&quot;</span>); Serial.print(luminosity); Serial.println(<span class="string">&quot; lux&quot;</span>);</span><br><span class="line">  Serial.println(<span class="string">&quot;=====================================&quot;</span>);</span><br><span class="line">  Serial.println(<span class="string">&quot;&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">update_tft</span><span class="params">(<span class="keyword">float</span> temp, <span class="keyword">float</span> humidity, <span class="keyword">float</span> pressure, <span class="keyword">float</span> altitude, <span class="keyword">float</span> dewpoint, <span class="keyword">float</span> SQM)</span> </span>&#123;</span><br><span class="line">  tft.fillScreen(ST77XX_BLACK);</span><br><span class="line">  tft.setFont(&amp;FreeSans9pt7b);</span><br><span class="line"></span><br><span class="line">  tft.setCursor(<span class="number">4</span>, <span class="number">18</span>);</span><br><span class="line">  tft.setTextColor(ST77XX_WHITE);</span><br><span class="line">  tft.print(<span class="string">&quot;Weather Station&quot;</span>);</span><br><span class="line">  <span class="keyword">if</span> (WiFi.status() != WL_CONNECTED) &#123;</span><br><span class="line">    tft.drawBitmap(<span class="number">140</span>, <span class="number">4</span>, icon_wifi, <span class="number">16</span>, <span class="number">16</span>, RED);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span> &#123;</span><br><span class="line">    tft.drawBitmap(<span class="number">140</span>, <span class="number">4</span>, icon_wifi, <span class="number">16</span>, <span class="number">16</span>, GREEN);</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  tft.drawLine(<span class="number">0</span>, <span class="number">24</span>, <span class="number">160</span>, <span class="number">24</span>, WHITE);</span><br><span class="line"></span><br><span class="line">  tft.drawBitmap(<span class="number">0</span>, <span class="number">32</span>, icon_temp, <span class="number">24</span>, <span class="number">24</span>, WHITE);</span><br><span class="line">  tft.setCursor(<span class="number">26</span>, <span class="number">47</span>);</span><br><span class="line">  tft.setTextColor(ST77XX_WHITE);</span><br><span class="line">  tft.print(temp);</span><br><span class="line">  tft.setFont(<span class="literal">NULL</span>); tft.setCursor(<span class="number">72</span>,<span class="number">50</span>); tft.print(<span class="string">&quot;C&quot;</span>); tft.setFont(&amp;FreeSans9pt7b);</span><br><span class="line"></span><br><span class="line">  tft.drawBitmap(<span class="number">80</span>, <span class="number">32</span>, icon_SQM, <span class="number">24</span>, <span class="number">24</span>, WHITE);</span><br><span class="line">  tft.setCursor(<span class="number">106</span>, <span class="number">46</span>);</span><br><span class="line">  tft.setTextColor(ST77XX_WHITE);</span><br><span class="line">  tft.print(SQM);</span><br><span class="line">  tft.setFont(<span class="literal">NULL</span>); tft.setCursor(<span class="number">108</span>,<span class="number">49</span>); tft.print(<span class="string">&quot;Mag/as2&quot;</span>); tft.setFont(&amp;FreeSans9pt7b);</span><br><span class="line"></span><br><span class="line">  tft.drawBitmap(<span class="number">0</span>, <span class="number">66</span>, icon_humidity, <span class="number">24</span>, <span class="number">24</span>, WHITE);</span><br><span class="line">  tft.setCursor(<span class="number">26</span>, <span class="number">84</span>);</span><br><span class="line">  tft.setTextColor(ST77XX_WHITE);</span><br><span class="line">  tft.print(humidity);</span><br><span class="line">  tft.setFont(<span class="literal">NULL</span>); tft.setCursor(<span class="number">72</span>,<span class="number">88</span>); tft.print(<span class="string">&quot;%&quot;</span>); tft.setFont(&amp;FreeSans9pt7b);</span><br><span class="line"></span><br><span class="line">  tft.drawBitmap(<span class="number">80</span>, <span class="number">66</span>, icon_pressure, <span class="number">24</span>, <span class="number">24</span>, WHITE);</span><br><span class="line">  tft.setCursor(<span class="number">105</span>, <span class="number">84</span>);</span><br><span class="line">  tft.setTextColor(ST77XX_WHITE);</span><br><span class="line">  tft.print(pressure, <span class="number">1</span>);</span><br><span class="line">  tft.setFont(<span class="literal">NULL</span>); tft.setCursor(<span class="number">140</span>,<span class="number">88</span>); tft.print(<span class="string">&quot;hPa&quot;</span>); tft.setFont(&amp;FreeSans9pt7b);</span><br><span class="line"></span><br><span class="line">  tft.drawBitmap(<span class="number">0</span>, <span class="number">100</span>, icon_dew, <span class="number">24</span>, <span class="number">24</span>, WHITE);</span><br><span class="line">  tft.setCursor(<span class="number">26</span>, <span class="number">117</span>);</span><br><span class="line">  tft.setTextColor(ST77XX_WHITE);</span><br><span class="line">  tft.print(dewpoint);</span><br><span class="line">  tft.setFont(<span class="literal">NULL</span>); tft.setCursor(<span class="number">72</span>,<span class="number">120</span>); tft.print(<span class="string">&quot;C&quot;</span>); tft.setFont(&amp;FreeSans9pt7b);</span><br><span class="line"></span><br><span class="line">  tft.drawBitmap(<span class="number">80</span>, <span class="number">100</span>, icon_altitude, <span class="number">24</span>, <span class="number">24</span>, WHITE);</span><br><span class="line">  tft.setCursor(<span class="number">105</span>, <span class="number">117</span>);</span><br><span class="line">  tft.setTextColor(ST77XX_WHITE);</span><br><span class="line">  tft.print(altitude);</span><br><span class="line">  tft.setFont(<span class="literal">NULL</span>); tft.setCursor(<span class="number">152</span>,<span class="number">119</span>); tft.print(<span class="string">&quot;m&quot;</span>); tft.setFont(&amp;FreeSans9pt7b);</span><br><span class="line">  </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">connect_wifi</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  Serial.println(<span class="string">&quot;===========WiFi Connection===========&quot;</span>);</span><br><span class="line">  WiFi.mode(WIFI_STA); <span class="comment">// set to station mode</span></span><br><span class="line">  WiFi.disconnect(); <span class="comment">// init</span></span><br><span class="line">  delay(<span class="number">100</span>);</span><br><span class="line">  Serial.println(<span class="string">&quot;WiFi setup done&quot;</span>);</span><br><span class="line"></span><br><span class="line">  WiFi.begin(WLAN_SSID, WLAN_PASSWD);</span><br><span class="line">  delay(WLAN_TIMEOUT_MS); <span class="comment">// important, don&#x27;t make the delay too short</span></span><br><span class="line">  <span class="keyword">if</span> (WiFi.status() != WL_CONNECTED) &#123;</span><br><span class="line">    Serial.println(<span class="string">&quot;WiFi connection failed!&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span> &#123;</span><br><span class="line">    Serial.println(<span class="string">&quot;WiFi connection successed!&quot;</span>);</span><br><span class="line">    Serial.print(<span class="string">&quot;IP: &quot;</span>);</span><br><span class="line">    Serial.println(WiFi.localIP());</span><br><span class="line">  &#125;</span><br><span class="line">  Serial.println(<span class="string">&quot;=====================================&quot;</span>);</span><br><span class="line">  Serial.println(<span class="string">&quot;&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//publish the data to Adafruit IO</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">send_data</span><span class="params">(<span class="keyword">float</span> temp, <span class="keyword">float</span> humidity, <span class="keyword">float</span> pressure, <span class="keyword">float</span> altitude, <span class="keyword">float</span> dewpoint, <span class="keyword">float</span> SQM)</span> </span>&#123;</span><br><span class="line">  Serial.println(<span class="string">&quot;======Send data to Adafruit IO======&quot;</span>);</span><br><span class="line">  <span class="keyword">if</span> (AIO_temp.publish(temp)) &#123;</span><br><span class="line">    Serial.println(<span class="string">&quot;Sent data!&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span> &#123;</span><br><span class="line">    Serial.println(<span class="string">&quot;Failed to send data!&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  AIO_humidity.publish(humidity);</span><br><span class="line">  AIO_pressure.publish(pressure);</span><br><span class="line">  AIO_altitude.publish(altitude);</span><br><span class="line">  AIO_SQM.publish(SQM);</span><br><span class="line">  AIO_dewpoint.publish(dewpoint);</span><br><span class="line">  Serial.println(<span class="string">&quot;=====================================&quot;</span>);</span><br><span class="line">  Serial.println(<span class="string">&quot;&quot;</span>);  </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// connect to Adafruit IO</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">connect_adafruit</span><span class="params">()</span> </span>&#123; </span><br><span class="line">  Serial.println(<span class="string">&quot;======Connecting to Adafruit IO======&quot;</span>);</span><br><span class="line">  <span class="keyword">int8_t</span> ret;</span><br><span class="line">  <span class="keyword">if</span> ((ret = mqtt.connect()) != <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="keyword">switch</span> (ret) &#123;</span><br><span class="line">      <span class="keyword">case</span> <span class="number">1</span>: Serial.println(F(<span class="string">&quot;[ERROR] Wrong protocol&quot;</span>)); <span class="keyword">break</span>;</span><br><span class="line">      <span class="keyword">case</span> <span class="number">2</span>: Serial.println(F(<span class="string">&quot;[ERROR] ID rejected&quot;</span>)); <span class="keyword">break</span>;</span><br><span class="line">      <span class="keyword">case</span> <span class="number">3</span>: Serial.println(F(<span class="string">&quot;[ERROR] Server unavailable&quot;</span>)); <span class="keyword">break</span>;</span><br><span class="line">      <span class="keyword">case</span> <span class="number">4</span>: Serial.println(F(<span class="string">&quot;[ERROR] Bad username/password&quot;</span>)); <span class="keyword">break</span>;</span><br><span class="line">      <span class="keyword">case</span> <span class="number">5</span>: Serial.println(F(<span class="string">&quot;[ERROR] Not authorized&quot;</span>)); <span class="keyword">break</span>;</span><br><span class="line">      <span class="keyword">case</span> <span class="number">6</span>: Serial.println(F(<span class="string">&quot;[ERROR] Failed to subscribe&quot;</span>)); <span class="keyword">break</span>;</span><br><span class="line">      <span class="keyword">default</span>: Serial.println(F(<span class="string">&quot;[ERROR] Connection failed&quot;</span>)); <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  Serial.println(<span class="string">&quot;=====================================&quot;</span>);</span><br><span class="line">  Serial.println(<span class="string">&quot;&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>我們從程式碼一一來看，這裡新增了WiFi聯網功能以及Adafruit IO的資料推送功能<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;WiFi.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;Adafruit_MQTT.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;Adafruit_MQTT_Client.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">//Wi-Fi parameters</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> WLAN_SSID <span class="meta-string">&quot;Wooster&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> WLAN_PASSWD <span class="meta-string">&quot;123456789&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> WLAN_TIMEOUT_MS 15000</span></span><br><span class="line"><span class="comment">// Adafruit IO</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> AIO_SERVER <span class="meta-string">&quot;io.adafruit.com&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> AIO_SERVERPORT 1883</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> AIO_USERNAME <span class="meta-string">&quot;jamiechang917&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> AIO_KEY <span class="meta-string">&quot;填入你的金鑰(key)&quot;</span></span></span><br></pre></td></tr></table></figure><br><code>WLAN_SSID</code>是你的WiFi名稱，下面則是密碼，需要寫在程式碼裡面。另外Adafruit IO的Server網址及端口也要寫，下面則是Adafruit帳號和金鑰。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> SCREEN_REFRESH_TIME 10 <span class="comment">// (second) refresh the screen every 10 seconds</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> SEND_DATA_TIME 15 <span class="comment">// (second) send data to adafruit io every 15 seconds</span></span></span><br></pre></td></tr></table></figure>
<p>這兩行是我自己定義的，我將螢幕刷新時間設定為10秒，而發送資料到Adafruit IO的時間間隔為15秒。要實現這種每隔幾秒做一件事情的功能很簡單，我們先定義兩個計數器</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span> refresh_cnt = <span class="number">0</span>, send_cnt = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">loop</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">if</span> (refresh_cnt &gt;= SCREEN_REFRESH_TIME) &#123;</span><br><span class="line">    refresh_cnt = <span class="number">0</span>;</span><br><span class="line">    <span class="comment">// 更新你的螢幕</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (send_cnt &gt;= SEND_DATA_TIME) &#123;</span><br><span class="line">    send_cnt = <span class="number">0</span>;</span><br><span class="line">    <span class="comment">// 發送資料</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  refresh_cnt += <span class="number">1</span>;</span><br><span class="line">  send_cnt += <span class="number">1</span>;</span><br><span class="line">  delay(<span class="number">1000</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在<code>loop()</code>迴圈裡，我設定<code>delay(1000)</code>，這樣一來每隔一秒這兩個計數器就會加一，而當他們達到上限時，就會進入相對應的程式碼區塊。舉發送資料的例子，當計數器到15的時候就開始發送資料，而動作結束後這個計數器也會重新歸零。如此反覆循環就能達成每隔15秒發送一次資料的功能。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">WiFiClient client;</span><br><span class="line"><span class="function">Adafruit_MQTT_Client <span class="title">mqtt</span><span class="params">(&amp;client, AIO_SERVER, AIO_SERVERPORT, AIO_USERNAME, AIO_KEY)</span></span>;</span><br><span class="line">Adafruit_MQTT_Publish AIO_temp = Adafruit_MQTT_Publish(&amp;mqtt, AIO_USERNAME <span class="string">&quot;/feeds/temperature&quot;</span>);</span><br><span class="line">Adafruit_MQTT_Publish AIO_humidity = Adafruit_MQTT_Publish(&amp;mqtt, AIO_USERNAME <span class="string">&quot;/feeds/humidity&quot;</span>);</span><br><span class="line">Adafruit_MQTT_Publish AIO_SQM = Adafruit_MQTT_Publish(&amp;mqtt, AIO_USERNAME <span class="string">&quot;/feeds/sqm&quot;</span>);</span><br><span class="line">Adafruit_MQTT_Publish AIO_pressure = Adafruit_MQTT_Publish(&amp;mqtt, AIO_USERNAME <span class="string">&quot;/feeds/pressure&quot;</span>);</span><br><span class="line">Adafruit_MQTT_Publish AIO_altitude = Adafruit_MQTT_Publish(&amp;mqtt, AIO_USERNAME <span class="string">&quot;/feeds/altitude&quot;</span>);</span><br><span class="line">Adafruit_MQTT_Publish AIO_dewpoint = Adafruit_MQTT_Publish(&amp;mqtt, AIO_USERNAME <span class="string">&quot;/feeds/dew-point&quot;</span>);</span><br></pre></td></tr></table></figure>
<p>開頭兩行分別建立WiFi以及MQTT的Client。另外其他的是feed，在Adafruit的dashboard裡，要監測的變量稱為feed，在程式碼裡要建立<code>Adafruit_MQTT_Publish</code>類的變數，格式如上。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">connect_wifi</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  Serial.println(<span class="string">&quot;===========WiFi Connection===========&quot;</span>);</span><br><span class="line">  WiFi.mode(WIFI_STA); <span class="comment">// set to station mode</span></span><br><span class="line">  WiFi.disconnect(); <span class="comment">// init</span></span><br><span class="line">  delay(<span class="number">100</span>);</span><br><span class="line">  Serial.println(<span class="string">&quot;WiFi setup done&quot;</span>);</span><br><span class="line"></span><br><span class="line">  WiFi.begin(WLAN_SSID, WLAN_PASSWD);</span><br><span class="line">  delay(WLAN_TIMEOUT_MS); <span class="comment">// important, don&#x27;t make the delay too short</span></span><br><span class="line">  <span class="keyword">if</span> (WiFi.status() != WL_CONNECTED) &#123;</span><br><span class="line">    Serial.println(<span class="string">&quot;WiFi connection failed!&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span> &#123;</span><br><span class="line">    Serial.println(<span class="string">&quot;WiFi connection successed!&quot;</span>);</span><br><span class="line">    Serial.print(<span class="string">&quot;IP: &quot;</span>);</span><br><span class="line">    Serial.println(WiFi.localIP());</span><br><span class="line">  &#125;</span><br><span class="line">  Serial.println(<span class="string">&quot;=====================================&quot;</span>);</span><br><span class="line">  Serial.println(<span class="string">&quot;&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>我將連結WiFi的基本步驟寫成一個函式，首先<code>WiFi.mode()</code>是設定WiFi晶片的模式，可以是STA或是AP模式，如果是要發送資料到網路上，需要使用STA模式。連接WiFi的話使用<code>WiFi.begin(WLAN_SSID, WLAN_PASSWD)</code>，分別填入SSID和密碼，<strong>要注意的是下面一行的<code>delay(WLAN_TIMEOUT_MS)</code>，這裡我設定15秒，千萬不要設定太短，否則NodeMCU-32S將會來不及連接WiFi，導致永遠連不上的狀況</strong>。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// connect to Adafruit IO</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">connect_adafruit</span><span class="params">()</span> </span>&#123; </span><br><span class="line">  Serial.println(<span class="string">&quot;======Connecting to Adafruit IO======&quot;</span>);</span><br><span class="line">  <span class="keyword">int8_t</span> ret;</span><br><span class="line">  <span class="keyword">if</span> ((ret = mqtt.connect()) != <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="keyword">switch</span> (ret) &#123;</span><br><span class="line">      <span class="keyword">case</span> <span class="number">1</span>: Serial.println(F(<span class="string">&quot;[ERROR] Wrong protocol&quot;</span>)); <span class="keyword">break</span>;</span><br><span class="line">      <span class="keyword">case</span> <span class="number">2</span>: Serial.println(F(<span class="string">&quot;[ERROR] ID rejected&quot;</span>)); <span class="keyword">break</span>;</span><br><span class="line">      <span class="keyword">case</span> <span class="number">3</span>: Serial.println(F(<span class="string">&quot;[ERROR] Server unavailable&quot;</span>)); <span class="keyword">break</span>;</span><br><span class="line">      <span class="keyword">case</span> <span class="number">4</span>: Serial.println(F(<span class="string">&quot;[ERROR] Bad username/password&quot;</span>)); <span class="keyword">break</span>;</span><br><span class="line">      <span class="keyword">case</span> <span class="number">5</span>: Serial.println(F(<span class="string">&quot;[ERROR] Not authorized&quot;</span>)); <span class="keyword">break</span>;</span><br><span class="line">      <span class="keyword">case</span> <span class="number">6</span>: Serial.println(F(<span class="string">&quot;[ERROR] Failed to subscribe&quot;</span>)); <span class="keyword">break</span>;</span><br><span class="line">      <span class="keyword">default</span>: Serial.println(F(<span class="string">&quot;[ERROR] Connection failed&quot;</span>)); <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span> &#123;</span><br><span class="line">    Serial.println(<span class="string">&quot;Adafruit IO connection successed!&quot;</span>)</span><br><span class="line">  &#125;</span><br><span class="line">  Serial.println(<span class="string">&quot;=====================================&quot;</span>);</span><br><span class="line">  Serial.println(<span class="string">&quot;&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>這部分是連接Adafruit IO的步驟，再連接完WiFi後使用。方式很簡單，調用<code>mqtt.connect()</code>就可以了，這個函式會返回一個整數，0代表成功，其他數字代表不同的連接狀況，如果發生狀況，我將狀況印在Serial Monitor上，方便debug。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//publish the data to Adafruit IO</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">send_data</span><span class="params">(<span class="keyword">float</span> temp, <span class="keyword">float</span> humidity, <span class="keyword">float</span> pressure, <span class="keyword">float</span> altitude, <span class="keyword">float</span> dewpoint, <span class="keyword">float</span> SQM)</span> </span>&#123;</span><br><span class="line">  Serial.println(<span class="string">&quot;======Send data to Adafruit IO======&quot;</span>);</span><br><span class="line">  <span class="keyword">if</span> (AIO_temp.publish(temp)) &#123;</span><br><span class="line">    Serial.println(<span class="string">&quot;Sent data!&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span> &#123;</span><br><span class="line">    Serial.println(<span class="string">&quot;Failed to send data!&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  AIO_humidity.publish(humidity);</span><br><span class="line">  AIO_pressure.publish(pressure);</span><br><span class="line">  AIO_altitude.publish(altitude);</span><br><span class="line">  AIO_SQM.publish(SQM);</span><br><span class="line">  AIO_dewpoint.publish(dewpoint);</span><br><span class="line">  Serial.println(<span class="string">&quot;=====================================&quot;</span>);</span><br><span class="line">  Serial.println(<span class="string">&quot;&quot;</span>);  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>當連結到Adafruit IO後，將先前建立的<code>Adafruit_MQTT_Publish</code>類型變數後方加上<code>.publish</code>就可以發布資料到該feed。</p>
<p><img src="https://i.imgur.com/uDNvsar.jpg" alt=""></p>
<h2 id="成品與心得"><a href="#成品與心得" class="headerlink" title="成品與心得"></a>成品與心得</h2><p>最近因疫情嚴峻，想買個零件都要等超過一星期，而且一開始挑選的一些零件甚至沒貨，只好另尋替代品，不過經過一番調整，總算做出一個土炮攜帶型天氣站了，我暫時用樂高拼了一個殼給它，未來再用3D列印給它更好的家。</p>
<p><img src="https://i.imgur.com/sZAGi9Z.jpg" alt=""></p>
<p>初步校正後，我關燈比較看看SQM和天氣站的數值，看起來是相當接近阿，我個人很滿意，而且未來還能去山上進行更精細的調教。</p>
<p><img src="https://i.imgur.com/XuOgEAV.jpg" alt=""></p>
<p>最困難的地方我覺得還是螢幕版面的設計，要自己找icon還要在有限的空間內塞入這麼多東西，花了不少時間才弄好，但是做完後實在是賞心悅目，一眼就能看到所有資訊，打開WiFi還能上傳資料，以後在山上天冷了也能躲在車裡看，不用坐在外頭吹冷風 :)。</p>
<p>最後附上程式碼</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;math.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;Wire.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;SPI.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;Adafruit_Sensor.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;Adafruit_BME280.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;Adafruit_TSL2591.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;Adafruit_GFX.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;Adafruit_ST7735.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;Fonts/FreeSans9pt7b.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;WiFi.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;Adafruit_MQTT.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;Adafruit_MQTT_Client.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">//Wi-Fi parameters</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> WLAN_SSID <span class="meta-string">&quot;Wooster&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> WLAN_PASSWD <span class="meta-string">&quot;123456789&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> WLAN_TIMEOUT_MS 15000</span></span><br><span class="line"><span class="comment">// Adafruit IO</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> AIO_SERVER <span class="meta-string">&quot;io.adafruit.com&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> AIO_SERVERPORT 1883</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> AIO_USERNAME <span class="meta-string">&quot;jamiechang917&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> AIO_KEY <span class="meta-string">&quot;AIO金鑰&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> SEALEVELPRESSURE_HPA 1003.0 <span class="comment">// 1 atm = 1013.25 hPa</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> GAIN TSL2591_GAIN_HIGH <span class="comment">// (LOW, MID, HIGH)</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> INTEGRATIONTIME TSL2591_INTEGRATIONTIME_500MS <span class="comment">// (100MS,200MS,300MS,400MS,500MS,600MS)</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> EFFECTIVE_SOLID_ANGLE 1.4 <span class="comment">// solid angle in steradians for SQM</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CALIBRATION_COEFF_A 1.0 <span class="comment">// SQM = 12.5836 - COEFF_A*log(lux/solid_angle)/(-0.4) + COEFF_B</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CALIBRATION_COEFF_B 0.0</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> SCREEN_REFRESH_TIME 10 <span class="comment">// (second) refresh the screen every 10 seconds</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> SEND_DATA_TIME 15 <span class="comment">// (second) send data to adafruit io every 15 seconds</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> RECONNECTION_TIME 60 <span class="comment">// (second) reconnect wifi every 60 seconds if disconnected</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> LOOP_DELAY_TIME 0.1 <span class="comment">// (second) delay time in the loop() function</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> TFT_CS   5 </span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> TFT_DC   17</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> TFT_RST  0</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> TFT_Vcc  16</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> Button   4</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> BLACK   0x0000</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> BLUE    0x001F</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> RED     0xF800</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> GREEN   0x07E0</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CYAN    0x07FF</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MAGENTA 0xF81F</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> YELLOW  0xFFE0</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> WHITE   0xFFFF</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> GREY     0xD6BA</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//Setup the WiFi and MQTT client</span></span><br><span class="line">WiFiClient client;</span><br><span class="line"><span class="function">Adafruit_MQTT_Client <span class="title">mqtt</span><span class="params">(&amp;client, AIO_SERVER, AIO_SERVERPORT, AIO_USERNAME, AIO_KEY)</span></span>;</span><br><span class="line">Adafruit_MQTT_Publish AIO_temp = Adafruit_MQTT_Publish(&amp;mqtt, AIO_USERNAME <span class="string">&quot;/feeds/temperature&quot;</span>);</span><br><span class="line">Adafruit_MQTT_Publish AIO_humidity = Adafruit_MQTT_Publish(&amp;mqtt, AIO_USERNAME <span class="string">&quot;/feeds/humidity&quot;</span>);</span><br><span class="line">Adafruit_MQTT_Publish AIO_SQM = Adafruit_MQTT_Publish(&amp;mqtt, AIO_USERNAME <span class="string">&quot;/feeds/sqm&quot;</span>);</span><br><span class="line">Adafruit_MQTT_Publish AIO_pressure = Adafruit_MQTT_Publish(&amp;mqtt, AIO_USERNAME <span class="string">&quot;/feeds/pressure&quot;</span>);</span><br><span class="line">Adafruit_MQTT_Publish AIO_altitude = Adafruit_MQTT_Publish(&amp;mqtt, AIO_USERNAME <span class="string">&quot;/feeds/altitude&quot;</span>);</span><br><span class="line">Adafruit_MQTT_Publish AIO_dewpoint = Adafruit_MQTT_Publish(&amp;mqtt, AIO_USERNAME <span class="string">&quot;/feeds/dew-point&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// setup the sensors</span></span><br><span class="line">Adafruit_BME280 bme; <span class="comment">// I2C</span></span><br><span class="line">Adafruit_TSL2591 tsl = Adafruit_TSL2591(<span class="number">2591</span>);</span><br><span class="line">Adafruit_ST7735 tft = Adafruit_ST7735(TFT_CS, TFT_DC, TFT_RST);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">float</span> temp, humidity, pressure, altitude, luminosity, dewpoint, SQM;</span><br><span class="line"><span class="keyword">int</span> refresh_cnt = <span class="number">0</span>, send_cnt = <span class="number">0</span>, reconnect_cnt = <span class="number">0</span>; </span><br><span class="line"><span class="keyword">int</span> display_state = <span class="number">1</span>, button_state = <span class="number">1</span>, old_button_state = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// icon&#x27;s bitmap</span></span><br><span class="line"><span class="keyword">extern</span> <span class="keyword">uint8_t</span> icon_temp[];</span><br><span class="line"><span class="keyword">extern</span> <span class="keyword">uint8_t</span> icon_humidity[];</span><br><span class="line"><span class="keyword">extern</span> <span class="keyword">uint8_t</span> icon_pressure[];</span><br><span class="line"><span class="keyword">extern</span> <span class="keyword">uint8_t</span> icon_SQM[];</span><br><span class="line"><span class="keyword">extern</span> <span class="keyword">uint8_t</span> icon_dew[];</span><br><span class="line"><span class="keyword">extern</span> <span class="keyword">uint8_t</span> icon_altitude[];</span><br><span class="line"><span class="keyword">extern</span> <span class="keyword">uint8_t</span> icon_wifi[];</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">setup</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  Serial.begin(<span class="number">115200</span>);</span><br><span class="line"></span><br><span class="line">  pinMode(TFT_Vcc, OUTPUT);</span><br><span class="line">  digitalWrite(TFT_Vcc, HIGH);</span><br><span class="line">  pinMode(Button, INPUT);</span><br><span class="line">  digitalWrite(LED_BUILTIN, LOW);</span><br><span class="line"></span><br><span class="line">  init_bme280();</span><br><span class="line">  init_tsl2591();</span><br><span class="line">  init_tft();</span><br><span class="line">  measure();</span><br><span class="line">  update_tft();</span><br><span class="line"></span><br><span class="line">  connect_wifi();</span><br><span class="line">  connect_adafruit();</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">loop</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  old_button_state = button_state;</span><br><span class="line">  button_state = digitalRead(Button);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (button_state == <span class="number">0</span> &amp;&amp; old_button_state == <span class="number">1</span>) &#123; <span class="comment">// on/off the display</span></span><br><span class="line">      display_state = <span class="number">1</span> - display_state;</span><br><span class="line">      digitalWrite(TFT_Vcc, display_state);</span><br><span class="line">      <span class="keyword">if</span> (display_state == <span class="number">1</span>) &#123; <span class="comment">// turn on the screen</span></span><br><span class="line">        init_tft();</span><br><span class="line">        update_tft();</span><br><span class="line">      &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (refresh_cnt &gt;= SCREEN_REFRESH_TIME/LOOP_DELAY_TIME) &#123;</span><br><span class="line">    refresh_cnt = <span class="number">0</span>;</span><br><span class="line">    measure();</span><br><span class="line">    update_tft();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (send_cnt &gt;= SEND_DATA_TIME/LOOP_DELAY_TIME) &#123;</span><br><span class="line">    send_cnt = <span class="number">0</span>;</span><br><span class="line">    measure();</span><br><span class="line">    <span class="comment">// send data to adafruit io</span></span><br><span class="line">    send_data();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (reconnect_cnt &gt;= RECONNECTION_TIME/LOOP_DELAY_TIME) &#123;</span><br><span class="line">    reconnect_cnt = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">if</span> (!mqtt.connected()) &#123; <span class="comment">// reconnect when disconnecting</span></span><br><span class="line">      Serial.println(<span class="string">&quot;Reconnecting...&quot;</span>);</span><br><span class="line">      connect_wifi();</span><br><span class="line">      connect_adafruit();</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  refresh_cnt += <span class="number">1</span>;</span><br><span class="line">  send_cnt += <span class="number">1</span>;</span><br><span class="line">  reconnect_cnt += <span class="number">1</span>;</span><br><span class="line">  delay(LOOP_DELAY_TIME*<span class="number">1000</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">init_bme280</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  bme.begin(<span class="number">0x76</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">init_tsl2591</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  tsl.begin(<span class="number">0x29</span>);</span><br><span class="line">  tsl.setGain(GAIN);</span><br><span class="line">  tsl.setTiming(INTEGRATIONTIME);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">init_tft</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  tft.initR(INITR_BLACKTAB); <span class="comment">// for 1.8&quot; ST7735 TFT display</span></span><br><span class="line">  tft.setRotation(<span class="number">1</span>);  <span class="comment">//screen rotation</span></span><br><span class="line">  tft.setTextWrap(<span class="literal">false</span>);</span><br><span class="line">  tft.fillScreen(ST77XX_BLACK);  <span class="comment">//filled with black color</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">float</span> <span class="title">get_temperature</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> bme.readTemperature();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">float</span> <span class="title">get_humidity</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> bme.readHumidity();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">float</span> <span class="title">get_altitude</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> bme.readAltitude(SEALEVELPRESSURE_HPA);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">float</span> <span class="title">get_pressure</span><span class="params">()</span> </span>&#123; <span class="comment">// return hPa</span></span><br><span class="line">  <span class="keyword">return</span> bme.readPressure()/<span class="number">100.0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">float</span> <span class="title">get_luminosity</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="keyword">uint32_t</span> lum = tsl.getFullLuminosity();</span><br><span class="line">  <span class="keyword">uint16_t</span> ir,full;</span><br><span class="line">  ir = lum &gt;&gt; <span class="number">16</span>;</span><br><span class="line">  full = lum &amp; <span class="number">0xFFFF</span>;</span><br><span class="line">  <span class="keyword">return</span> tsl.calculateLux(full, ir); <span class="comment">// return -1 if the value blows up</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">measure</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  temp = get_temperature();</span><br><span class="line">  humidity = get_humidity();</span><br><span class="line">  pressure = get_pressure();</span><br><span class="line">  altitude = get_altitude();</span><br><span class="line">  luminosity = get_luminosity();</span><br><span class="line"></span><br><span class="line">  <span class="comment">// calculate dew point</span></span><br><span class="line">  dewpoint = temp - ((<span class="number">100</span>-humidity)/<span class="number">5.</span>);</span><br><span class="line">  <span class="comment">// calculate SQM</span></span><br><span class="line">  <span class="comment">// SQM = log10f((luminosity/EFFECTIVE_SOLID_ANGLE)/108000)/(-0.4);</span></span><br><span class="line">  SQM = <span class="number">12.5836</span> + CALIBRATION_COEFF_A*log10f(luminosity/EFFECTIVE_SOLID_ANGLE)/(<span class="number">-0.4</span>) + CALIBRATION_COEFF_B;</span><br><span class="line"></span><br><span class="line">  Serial.println(<span class="string">&quot;=============Measurement=============&quot;</span>);</span><br><span class="line">  Serial.print(<span class="string">&quot;Temperature:\t&quot;</span>); Serial.print(temp); Serial.println(<span class="string">&quot; C&quot;</span>);</span><br><span class="line">  Serial.print(<span class="string">&quot;SQM Value:\t&quot;</span>); Serial.print(SQM); Serial.println(<span class="string">&quot; Mag/as^2&quot;</span>);</span><br><span class="line">  Serial.print(<span class="string">&quot;Humidity:\t&quot;</span>); Serial.print(humidity); Serial.println(<span class="string">&quot; %&quot;</span>);</span><br><span class="line">  Serial.print(<span class="string">&quot;Pressure:\t&quot;</span>); Serial.print(pressure); Serial.println(<span class="string">&quot; hPa&quot;</span>);</span><br><span class="line">  Serial.print(<span class="string">&quot;Altitude:\t&quot;</span>); Serial.print(altitude); Serial.println(<span class="string">&quot; m&quot;</span>);</span><br><span class="line">  Serial.print(<span class="string">&quot;Dew Point:\t&quot;</span>); Serial.print(dewpoint); Serial.println(<span class="string">&quot; C&quot;</span>);</span><br><span class="line">  Serial.print(<span class="string">&quot;Illuminance:\t&quot;</span>); Serial.print(luminosity,<span class="number">6</span>); Serial.println(<span class="string">&quot; lux&quot;</span>);</span><br><span class="line">  Serial.println(<span class="string">&quot;=====================================&quot;</span>);</span><br><span class="line">  Serial.println(<span class="string">&quot;&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">update_tft</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  tft.fillScreen(ST77XX_BLACK);</span><br><span class="line">  tft.setFont(&amp;FreeSans9pt7b);</span><br><span class="line"></span><br><span class="line">  tft.setCursor(<span class="number">4</span>, <span class="number">18</span>);</span><br><span class="line">  tft.setTextColor(ST77XX_WHITE);</span><br><span class="line">  tft.print(<span class="string">&quot;Weather Station&quot;</span>);</span><br><span class="line">  <span class="keyword">if</span> (WiFi.status() != WL_CONNECTED) &#123;</span><br><span class="line">    tft.drawBitmap(<span class="number">140</span>, <span class="number">4</span>, icon_wifi, <span class="number">16</span>, <span class="number">16</span>, RED);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span> &#123;</span><br><span class="line">    tft.drawBitmap(<span class="number">140</span>, <span class="number">4</span>, icon_wifi, <span class="number">16</span>, <span class="number">16</span>, GREEN);</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  tft.drawLine(<span class="number">0</span>, <span class="number">24</span>, <span class="number">160</span>, <span class="number">24</span>, WHITE);</span><br><span class="line"></span><br><span class="line">  tft.drawBitmap(<span class="number">0</span>, <span class="number">32</span>, icon_temp, <span class="number">24</span>, <span class="number">24</span>, WHITE);</span><br><span class="line">  tft.setCursor(<span class="number">26</span>, <span class="number">47</span>);</span><br><span class="line">  tft.setTextColor(ST77XX_WHITE);</span><br><span class="line">  tft.print(temp);</span><br><span class="line">  tft.setFont(<span class="literal">NULL</span>); tft.setCursor(<span class="number">72</span>,<span class="number">50</span>); tft.print(<span class="string">&quot;C&quot;</span>); tft.setFont(&amp;FreeSans9pt7b);</span><br><span class="line"></span><br><span class="line">  tft.drawBitmap(<span class="number">80</span>, <span class="number">32</span>, icon_SQM, <span class="number">24</span>, <span class="number">24</span>, WHITE);</span><br><span class="line">  tft.setCursor(<span class="number">106</span>, <span class="number">46</span>);</span><br><span class="line">  tft.setTextColor(ST77XX_WHITE);</span><br><span class="line">  tft.print(SQM);</span><br><span class="line">  tft.setFont(<span class="literal">NULL</span>); tft.setCursor(<span class="number">108</span>,<span class="number">49</span>); tft.print(<span class="string">&quot;Mag/as2&quot;</span>); tft.setFont(&amp;FreeSans9pt7b);</span><br><span class="line"></span><br><span class="line">  tft.drawBitmap(<span class="number">0</span>, <span class="number">66</span>, icon_humidity, <span class="number">24</span>, <span class="number">24</span>, WHITE);</span><br><span class="line">  tft.setCursor(<span class="number">26</span>, <span class="number">84</span>);</span><br><span class="line">  tft.setTextColor(ST77XX_WHITE);</span><br><span class="line">  tft.print(humidity);</span><br><span class="line">  tft.setFont(<span class="literal">NULL</span>); tft.setCursor(<span class="number">72</span>,<span class="number">88</span>); tft.print(<span class="string">&quot;%&quot;</span>); tft.setFont(&amp;FreeSans9pt7b);</span><br><span class="line"></span><br><span class="line">  tft.drawBitmap(<span class="number">80</span>, <span class="number">66</span>, icon_pressure, <span class="number">24</span>, <span class="number">24</span>, WHITE);</span><br><span class="line">  tft.setCursor(<span class="number">105</span>, <span class="number">84</span>);</span><br><span class="line">  tft.setTextColor(ST77XX_WHITE);</span><br><span class="line">  tft.print(pressure, <span class="number">1</span>);</span><br><span class="line">  tft.setFont(<span class="literal">NULL</span>); tft.setCursor(<span class="number">140</span>,<span class="number">88</span>); tft.print(<span class="string">&quot;hPa&quot;</span>); tft.setFont(&amp;FreeSans9pt7b);</span><br><span class="line"></span><br><span class="line">  tft.drawBitmap(<span class="number">0</span>, <span class="number">100</span>, icon_dew, <span class="number">24</span>, <span class="number">24</span>, WHITE);</span><br><span class="line">  tft.setCursor(<span class="number">26</span>, <span class="number">117</span>);</span><br><span class="line">  tft.setTextColor(ST77XX_WHITE);</span><br><span class="line">  tft.print(dewpoint);</span><br><span class="line">  tft.setFont(<span class="literal">NULL</span>); tft.setCursor(<span class="number">72</span>,<span class="number">120</span>); tft.print(<span class="string">&quot;C&quot;</span>); tft.setFont(&amp;FreeSans9pt7b);</span><br><span class="line"></span><br><span class="line">  tft.drawBitmap(<span class="number">80</span>, <span class="number">100</span>, icon_altitude, <span class="number">24</span>, <span class="number">24</span>, WHITE);</span><br><span class="line">  tft.setCursor(<span class="number">105</span>, <span class="number">117</span>);</span><br><span class="line">  tft.setTextColor(ST77XX_WHITE);</span><br><span class="line">  tft.print(altitude);</span><br><span class="line">  tft.setFont(<span class="literal">NULL</span>); tft.setCursor(<span class="number">152</span>,<span class="number">119</span>); tft.print(<span class="string">&quot;m&quot;</span>); tft.setFont(&amp;FreeSans9pt7b);</span><br><span class="line">  </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">connect_wifi</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  Serial.println(<span class="string">&quot;===========WiFi Connection===========&quot;</span>);</span><br><span class="line">  WiFi.mode(WIFI_STA); <span class="comment">// set to station mode</span></span><br><span class="line">  WiFi.disconnect(); <span class="comment">// init</span></span><br><span class="line">  delay(<span class="number">100</span>);</span><br><span class="line">  Serial.println(<span class="string">&quot;WiFi setup done&quot;</span>);</span><br><span class="line"></span><br><span class="line">  WiFi.begin(WLAN_SSID, WLAN_PASSWD);</span><br><span class="line">  delay(WLAN_TIMEOUT_MS); <span class="comment">// important, don&#x27;t make the delay too short</span></span><br><span class="line">  <span class="keyword">if</span> (WiFi.status() != WL_CONNECTED) &#123;</span><br><span class="line">    Serial.println(<span class="string">&quot;WiFi connection failed!&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span> &#123;</span><br><span class="line">    Serial.println(<span class="string">&quot;WiFi connection successed!&quot;</span>);</span><br><span class="line">    Serial.print(<span class="string">&quot;IP: &quot;</span>);</span><br><span class="line">    Serial.println(WiFi.localIP());</span><br><span class="line">  &#125;</span><br><span class="line">  Serial.println(<span class="string">&quot;=====================================&quot;</span>);</span><br><span class="line">  Serial.println(<span class="string">&quot;&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//publish the data to Adafruit IO</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">send_data</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  Serial.println(<span class="string">&quot;======Send data to Adafruit IO======&quot;</span>);</span><br><span class="line">  <span class="keyword">if</span> (AIO_temp.publish(temp)) &#123;</span><br><span class="line">    Serial.println(<span class="string">&quot;Sent data!&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span> &#123;</span><br><span class="line">    Serial.println(<span class="string">&quot;Failed to send data!&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  AIO_humidity.publish(humidity);</span><br><span class="line">  AIO_pressure.publish(pressure);</span><br><span class="line">  AIO_altitude.publish(altitude);</span><br><span class="line">  AIO_SQM.publish(SQM);</span><br><span class="line">  AIO_dewpoint.publish(dewpoint);</span><br><span class="line">  Serial.println(<span class="string">&quot;=====================================&quot;</span>);</span><br><span class="line">  Serial.println(<span class="string">&quot;&quot;</span>);  </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// connect to Adafruit IO</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">connect_adafruit</span><span class="params">()</span> </span>&#123; </span><br><span class="line">  Serial.println(<span class="string">&quot;======Connecting to Adafruit IO======&quot;</span>);</span><br><span class="line">  <span class="keyword">int8_t</span> ret;</span><br><span class="line">  <span class="keyword">if</span> ((ret = mqtt.connect()) != <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="keyword">switch</span> (ret) &#123;</span><br><span class="line">      <span class="keyword">case</span> <span class="number">1</span>: Serial.println(F(<span class="string">&quot;[ERROR] Wrong protocol&quot;</span>)); <span class="keyword">break</span>;</span><br><span class="line">      <span class="keyword">case</span> <span class="number">2</span>: Serial.println(F(<span class="string">&quot;[ERROR] ID rejected&quot;</span>)); <span class="keyword">break</span>;</span><br><span class="line">      <span class="keyword">case</span> <span class="number">3</span>: Serial.println(F(<span class="string">&quot;[ERROR] Server unavailable&quot;</span>)); <span class="keyword">break</span>;</span><br><span class="line">      <span class="keyword">case</span> <span class="number">4</span>: Serial.println(F(<span class="string">&quot;[ERROR] Bad username/password&quot;</span>)); <span class="keyword">break</span>;</span><br><span class="line">      <span class="keyword">case</span> <span class="number">5</span>: Serial.println(F(<span class="string">&quot;[ERROR] Not authorized&quot;</span>)); <span class="keyword">break</span>;</span><br><span class="line">      <span class="keyword">case</span> <span class="number">6</span>: Serial.println(F(<span class="string">&quot;[ERROR] Failed to subscribe&quot;</span>)); <span class="keyword">break</span>;</span><br><span class="line">      <span class="keyword">default</span>: Serial.println(F(<span class="string">&quot;[ERROR] Connection failed&quot;</span>)); <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span> &#123;</span><br><span class="line">    Serial.println(<span class="string">&quot;Adafruit IO connection successed!&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  Serial.println(<span class="string">&quot;=====================================&quot;</span>);</span><br><span class="line">  Serial.println(<span class="string">&quot;&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="更多功能"><a href="#更多功能" class="headerlink" title="更多功能"></a>更多功能</h2><ul>
<li>休眠與關機</li>
<li>雲量偵測器</li>
<li>corlysis (<a target="_blank" rel="noopener" href="https://www.hackster.io/michal-kren/simple-weather-station-with-amazing-web-monitoring-2b3044">https://www.hackster.io/michal-kren/simple-weather-station-with-amazing-web-monitoring-2b3044</a>)</li>
</ul>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="mailto:undefined">Jamie Chang</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章連結: </span><span class="post-copyright-info"><a href="https://jamiechang917.github.io/blog/2021/06/16/WeatherStationNodeMCU/">https://jamiechang917.github.io/blog/2021/06/16/WeatherStationNodeMCU/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版權聲明: </span><span class="post-copyright-info">本部落格所有文章除特別聲明外，均採用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 許可協議。轉載請註明來自 <a href="https://jamiechang917.github.io/blog" target="_blank">Jamie's Blog</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/blog/tags/astrophotography/">astrophotography</a><a class="post-meta__tags" href="/blog/tags/maker/">maker</a></div><div class="post_share"><div class="social-share" data-image="https://i.imgur.com/XuOgEAV.jpg" data-sites="facebook,twitter"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/social-share.js/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="next-post pull-full"><a href="/blog/2021/04/21/StarDiary04/"><img class="next-cover" src="https://i.imgur.com/d15wFs7.jpg" onerror="onerror=null;src='/blog/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">觀星日誌04</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span> 相關推薦</span></div><div class="relatedPosts-list"><div><a href="/blog/2021/03/25/StarDiary01/" title="觀星日誌01"><img class="cover" src="https://i.imgur.com/OQiRzMO.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2021-03-25</div><div class="title">觀星日誌01</div></div></a></div><div><a href="/blog/2021/03/27/StarDiary02/" title="觀星日誌02"><img class="cover" src="https://i.imgur.com/zHYXLOz.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2021-03-27</div><div class="title">觀星日誌02</div></div></a></div><div><a href="/blog/2021/04/21/StarDiary04/" title="觀星日誌04"><img class="cover" src="https://i.imgur.com/d15wFs7.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2021-04-21</div><div class="title">觀星日誌04</div></div></a></div><div><a href="/blog/2021/04/14/StarDiary03/" title="觀星日誌03"><img class="cover" src="https://i.imgur.com/FnOuQye.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2021-04-14</div><div class="title">觀星日誌03</div></div></a></div></div></div><hr/><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="fas fa-comments fa-fw"></i><span> 評論</span></div></div><div class="comment-wrap"><div><div id="disqus_thread"></div></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="card-info-avatar is-center"><img class="avatar-img" src="/blog/img/avatar_img.jpg" onerror="this.onerror=null;this.src='/blog/img/friend_404.gif'" alt="avatar"/><div class="author-info__name">Jamie Chang</div><div class="author-info__description">The personal blog</div></div><div class="card-info-data"><div class="card-info-data-item is-center"><a href="/blog/archives/"><div class="headline">文章</div><div class="length-num">7</div></a></div><div class="card-info-data-item is-center"><a href="/blog/tags/"><div class="headline">標籤</div><div class="length-num">5</div></a></div><div class="card-info-data-item is-center"><a href="/blog/categories/"><div class="headline">分類</div><div class="length-num">3</div></a></div></div><a class="button--animated" id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/jamiechang917"><i class="fab fa-github"></i><span>Follow Me</span></a><div class="card-info-social-icons is-center"><a class="social-icon" href="https://github.com/jamiechang917" target="_blank" title="Github"><i class="fab fa-github"></i></a><a class="social-icon" href="mailto:jamiechang917@gmail.com" target="_blank" title="Email"><i class="fas fa-envelope"></i></a></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn card-announcement-animation"></i><span>公告</span></div><div class="announcement_content">WIP</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目錄</span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%A4%A9%E6%96%87%E7%94%A8%E6%94%9C%E5%B8%B6%E5%9E%8B%E5%A4%A9%E6%B0%A3%E7%AB%99"><span class="toc-number">1.</span> <span class="toc-text">天文用攜帶型天氣站</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%9F%BA%E6%9C%AC%E4%BB%8B%E7%B4%B9"><span class="toc-number">1.1.</span> <span class="toc-text">基本介紹</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%96%8B%E7%99%BC%E6%9D%BF%E5%8F%8A%E6%84%9F%E6%B8%AC%E5%99%A8%E4%BB%8B%E7%B4%B9"><span class="toc-number">1.1.1.</span> <span class="toc-text">開發板及感測器介紹</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#NodeMCU-32S"><span class="toc-number">1.1.2.</span> <span class="toc-text">NodeMCU-32S</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#BME280-%E6%BA%AB%E6%BA%BC%E5%BA%A6%E6%B0%A3%E5%A3%93%E6%84%9F%E6%B8%AC%E5%99%A8"><span class="toc-number">1.1.3.</span> <span class="toc-text">BME280 溫溼度氣壓感測器</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#TSL2591-%E7%92%B0%E5%A2%83%E5%85%89%E6%84%9F%E6%B8%AC%E5%99%A8"><span class="toc-number">1.1.4.</span> <span class="toc-text">TSL2591 環境光感測器</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-8%E5%90%8BTFT%E8%9E%A2%E5%B9%95"><span class="toc-number">1.1.5.</span> <span class="toc-text">1.8吋TFT螢幕</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%89%E8%A3%9D%E5%8F%8A%E9%85%8D%E7%BD%AE%E9%96%8B%E7%99%BC%E7%92%B0%E5%A2%83"><span class="toc-number">1.2.</span> <span class="toc-text">安裝及配置開發環境</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%92%B0%E5%AF%AB%E5%A4%A9%E6%B0%A3%E7%AB%99%E8%BB%9F%E9%AB%94"><span class="toc-number">1.3.</span> <span class="toc-text">撰寫天氣站軟體</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%9F%BA%E6%9C%AC%E5%8A%9F%E8%83%BD-%E7%B5%90%E5%90%88BME280-TSL2591"><span class="toc-number">1.3.1.</span> <span class="toc-text">基本功能(結合BME280, TSL2591)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%B0%87%E6%95%B8%E6%93%9A%E9%A1%AF%E7%A4%BA%E5%9C%A8TFT%E8%9E%A2%E5%B9%95%E4%B8%8A"><span class="toc-number">1.3.2.</span> <span class="toc-text">將數據顯示在TFT螢幕上</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%9C%B2%E9%BB%9E%E6%BA%AB%E5%BA%A6%E5%8F%8ASQM%E6%95%B8%E5%80%BC%E8%A8%88%E7%AE%97"><span class="toc-number">1.3.3.</span> <span class="toc-text">露點溫度及SQM數值計算</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%9C%B2%E9%BB%9E%E6%BA%AB%E5%BA%A6"><span class="toc-number">1.3.3.1.</span> <span class="toc-text">露點溫度</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#SQM%E6%95%B8%E5%80%BC"><span class="toc-number">1.3.3.2.</span> <span class="toc-text">SQM數值</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%B6%B2%E8%B7%AF-IoT-%E5%8A%9F%E8%83%BD"><span class="toc-number">1.3.4.</span> <span class="toc-text">網路(IoT)功能</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%88%90%E5%93%81%E8%88%87%E5%BF%83%E5%BE%97"><span class="toc-number">1.4.</span> <span class="toc-text">成品與心得</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%9B%B4%E5%A4%9A%E5%8A%9F%E8%83%BD"><span class="toc-number">1.5.</span> <span class="toc-text">更多功能</span></a></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/blog/2021/06/16/WeatherStationNodeMCU/" title="天文用攜帶型天氣站"><img src="https://i.imgur.com/XuOgEAV.jpg" onerror="this.onerror=null;this.src='/blog/img/404.jpg'" alt="天文用攜帶型天氣站"/></a><div class="content"><a class="title" href="/blog/2021/06/16/WeatherStationNodeMCU/" title="天文用攜帶型天氣站">天文用攜帶型天氣站</a><time datetime="2021-06-16T04:00:00.000Z" title="發表於 2021-06-16 12:00:00">2021-06-16</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/blog/2021/04/21/StarDiary04/" title="觀星日誌04"><img src="https://i.imgur.com/d15wFs7.jpg" onerror="this.onerror=null;this.src='/blog/img/404.jpg'" alt="觀星日誌04"/></a><div class="content"><a class="title" href="/blog/2021/04/21/StarDiary04/" title="觀星日誌04">觀星日誌04</a><time datetime="2021-04-21T04:00:00.000Z" title="發表於 2021-04-21 12:00:00">2021-04-21</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/blog/2021/04/14/StarDiary03/" title="觀星日誌03"><img src="https://i.imgur.com/FnOuQye.jpg" onerror="this.onerror=null;this.src='/blog/img/404.jpg'" alt="觀星日誌03"/></a><div class="content"><a class="title" href="/blog/2021/04/14/StarDiary03/" title="觀星日誌03">觀星日誌03</a><time datetime="2021-04-14T04:00:00.000Z" title="發表於 2021-04-14 12:00:00">2021-04-14</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/blog/2021/03/27/StarDiary02/" title="觀星日誌02"><img src="https://i.imgur.com/zHYXLOz.jpg" onerror="this.onerror=null;this.src='/blog/img/404.jpg'" alt="觀星日誌02"/></a><div class="content"><a class="title" href="/blog/2021/03/27/StarDiary02/" title="觀星日誌02">觀星日誌02</a><time datetime="2021-03-27T04:00:00.000Z" title="發表於 2021-03-27 12:00:00">2021-03-27</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/blog/2021/03/25/StarDiary01/" title="觀星日誌01"><img src="https://i.imgur.com/OQiRzMO.jpg" onerror="this.onerror=null;this.src='/blog/img/404.jpg'" alt="觀星日誌01"/></a><div class="content"><a class="title" href="/blog/2021/03/25/StarDiary01/" title="觀星日誌01">觀星日誌01</a><time datetime="2021-03-25T04:00:00.000Z" title="發表於 2021-03-25 12:00:00">2021-03-25</time></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2021 By Jamie Chang</div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="閱讀模式"><i class="fas fa-book-open"></i></button><button id="font-plus" type="button" title="放大字型"><i class="fas fa-plus"></i></button><button id="font-minus" type="button" title="縮小字型"><i class="fas fa-minus"></i></button><button id="darkmode" type="button" title="淺色和深色模式轉換"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="單欄和雙欄切換"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="設定"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目錄"><i class="fas fa-list-ul"></i></button><a id="to_comment" href="#post-comment" title="直達評論"><i class="fas fa-comments"></i></a><button id="go-up" type="button" title="回到頂部"><i class="fas fa-arrow-up"></i></button></div></div><div id="local-search"><div class="search-dialog"><div class="search-dialog__title" id="local-search-title">本站搜尋</div><div id="local-input-panel"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="想找甚麼呢" type="text"/></div></div></div><hr/><div id="local-search-results"></div><span class="search-close-button"><i class="fas fa-times"></i></span></div><div id="search-mask"></div></div><div><script src="/blog/js/utils.js"></script><script src="/blog/js/main.js"></script><script src="https://cdn.jsdelivr.net/npm/instant.page/instantpage.min.js" type="module"></script><script src="https://cdn.jsdelivr.net/npm/node-snackbar/dist/snackbar.min.js"></script><script>function panguFn () {
  if (typeof pangu === 'object') pangu.autoSpacingPage()
  else {
    getScript('https://cdn.jsdelivr.net/npm/pangu/dist/browser/pangu.min.js')
      .then(() => {
        pangu.autoSpacingPage()
      })
  }
}

function panguInit () {
  if (false){
    GLOBAL_CONFIG_SITE.isPost && panguFn()
  } else {
    panguFn()
  }
}

document.addEventListener('DOMContentLoaded', panguInit)</script><script src="/blog/js/search/local-search.js"></script><script>var preloader = {
  endLoading: () => {
    document.body.style.overflow = 'auto';
    document.getElementById('loading-box').classList.add("loaded")
  },
  initLoading: () => {
    document.body.style.overflow = '';
    document.getElementById('loading-box').classList.remove("loaded")

  }
}
window.addEventListener('load',preloader.endLoading())</script><div class="js-pjax"><script>if (!window.MathJax) {
  window.MathJax = {
    loader: {
      source: {
        '[tex]/amsCd': '[tex]/amscd'
      }
    },
    tex: {
      inlineMath: [ ['$','$'], ["\\(","\\)"]],
      tags: 'ams'
    },
    options: {
      renderActions: {
        findScript: [10, doc => {
          for (const node of document.querySelectorAll('script[type^="math/tex"]')) {
            const display = !!node.type.match(/; *mode=display/)
            const math = new doc.options.MathItem(node.textContent, doc.inputJax[0], display)
            const text = document.createTextNode('')
            node.parentNode.replaceChild(text, node)
            math.start = {node: text, delim: '', n: 0}
            math.end = {node: text, delim: '', n: 0}
            doc.math.push(math)
          }
        }, ''],
        addClass: [200,() => {
          document.querySelectorAll('mjx-container:not([display=\'true\']').forEach( node => {
            const target = node.parentNode
            if (!target.classList.contains('has-jax')) {
              target.classList.add('mathjax-overflow')
            }
          })
        }, '', false]
      }
    }
  }
  
  const script = document.createElement('script')
  script.src = 'https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js'
  script.id = 'MathJax-script'
  script.async = true
  document.head.appendChild(script)
} else {
  MathJax.startup.document.state(0)
  MathJax.texReset()
  MathJax.typeset()
}</script><script>function loadDisqus () {
  var disqus_config = function () {
    this.page.url = 'https://jamiechang917.github.io/blog/2021/06/16/WeatherStationNodeMCU/'
    this.page.identifier = '2021/06/16/WeatherStationNodeMCU/'
    this.page.title = '天文用攜帶型天氣站'
  };

  window.disqusReset = () => {
    DISQUS.reset({
      reload: true,
      config: disqus_config
    })
  }

  if (window.DISQUS) disqusReset()
  else {
    (function() { 
      var d = document, s = d.createElement('script');
      s.src = 'https://jamiechang917-blog.disqus.com/embed.js';
      s.setAttribute('data-timestamp', +new Date());
      (d.head || d.body).appendChild(s);
    })();
  }
}

if ('Disqus' === 'Disqus' || !false) {
  if (false) btf.loadComment(document.getElementById('disqus_thread'), loadDisqus)
  else loadDisqus()
} else {
  function loadOtherComment () {
    loadDisqus()
  }
}
</script><script>if (window.DISQUSWIDGETS === undefined) {
  var d = document, s = d.createElement('script');
  s.src = 'https://jamiechang917-blog.disqus.com/count.js';
  s.id = 'dsq-count-scr';
  (d.head || d.body).appendChild(s);
} else {
  DISQUSWIDGETS.getCount({reset: true});
}</script></div><script defer src="https://cdn.jsdelivr.net/gh/graingert/wow@1.3.0/dist/wow.min.js"></ script><script defer data-pjax src="/js/wow_init.js"></script><script id="canvas_nest" defer="defer" color="0,230,255" opacity="0.9" zIndex="-1" count="99" mobile="false" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/dist/canvas-nest.min.js"></script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></body></html>